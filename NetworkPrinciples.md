# 1.概述

21世纪是知识经济的时代，但几乎所有的经济活动都依赖于信息的交流。目前信息的主要载体是计算机，而传播信息靠的就是计算机网络。计算机网络是现代通信技术与计算机技术紧密相结合的产物。
计算机网络的发展使计算机应用发生了巨大的变化，已经遍布经济、文化、科研、军事、政治、教育和社会生活等各个领域，引起了世界范围内信息产业的发展。

**计算机网络的发展史：**
根据计算机发展的特点，将计算机网络的发展过程大致分为以下4个阶段：

1.面向终端的计算机网络（20世纪50年代末-60年代初）
1951年，美国麻省理工学院为美国空军设计SAGE半自动化地面防空系统。
同期还有美国通用电气公司的信息服务系统（GE Information Service）----数据处理网络。

2．计算机网络互联阶段（20世纪60年代中期）
以程控交换机为特征的电信技术发展，典型代表是美国国防部高级研究计划局于1969年12月投入运行的ARPANET网络。

3.计算机网络标准化阶段（20世纪70年代）
随着计算机网络技术的发展，出现了各种不同体系的网络。为了使这些不同体系结构的计算机网络都能互联，国际标准化组织ISO提出OIS/RM开放式系统互联参考模型七层组成。

4.网络互联与高速网络阶段（20世纪80年代末至今）
INTERNET的飞速发展：电子邮件、电子传输、信息查询、语言图象服务等。
高速与智能发展：宽带综合业务数据网D—ISDN、异步传输ATM、ADSL技术
正在宽带方向上发展的“蓝牙”技术：它是一种新兴技术规范，目的是要在移动电话和其他手持式设备之间实现低成本、短距离的无线连接。（类似于红外线技术）
宽带IP网的发展：远程教育、视频点播、电子商务、电子会议等。

什么是计算机网络？
所谓的计算机网络就是把分布在不同区域的计算机与专门的设备用通信线路互相连成一个规模大、功能强的网络系统，从而使众多计算机可以方便地互相传递信息、共享硬件、软件、数据信息资源等的系统。



## 1.1计算机网络在信息时代中的作用

21世纪的一些重要特征是数字化、网络化和信息化，它是一个以网络为核心的信息时代。
网络现在已经成为信息社会的命脉和发展知识经济的重要基础。
大家熟悉的三大类网络有：
电信网络：提供电话、电报及传真等服务；
有线电视网络：向用户传送各种电视节目；
计算机网络：使用户能在计算机之间传送数据文件；
**发展最快的并起到核心作用的是计算机网络。**

自从20世纪90年代以后，以Internet为代表的计算机网络得到了飞速的发展。
已从最初的教育科研网络（免费）逐步发展成为商业网络（有偿使用）。
Internet已成为全球最大的和最重要的计算机网络。
Internet是人类自印刷术发明以来人类在存储和交换信息领域中的最大变革。

**Internet**的中文译名并不统一。现有的Internet译名有两种：
*因特网*，这个译名是全国科学技术名词审定委员会推荐的，但却长期未得到推广；
*互联网*，这是目前流行最广的、事实上的标准译名。现在我国的各种报刊杂志、政府文件以及电视节目中都毫无例外地使用这个译名。

互联网之所以能够向用户提供许多服务，是因为互联网具有**两个重要基本特点**：
**连通性(connectivity)**即数据通信
使上网用户之间都可以交换信息（数据，以及各种音频视频），好像这些用户的计算机都可以彼此直接连通一样。注意，互联网具有虚拟的特点，无法准确知道对方是谁，也无法知道对方的位置。
**共享(Sharing)**即资源共享。
资源共享的含义是多方面的。可以是信息共享、软件共享，也可以是硬件共享。
由于网络的存在，这些资源好像就在用户身边一样，方便使用。

**互联网+**
互联网+指“互联网+各个传统行业”。
利用信息通信技术以及互联网平台，让互联网与传统行业进行深度融合，创造新的发展生态。
特点：把互联网的创新成果深度融合于经济社会各领域之中，从而大大地提升了实体经济的创新力和生产力。

## 1.2互联网概述

**1.2.1网络的网络**
**互联网(Internet)**
特指Internet，起源于美国，现已发展成为世界上最大的、覆盖全球的计算机网络。
**计算机网络**(简称为网络)
由若干结点(node)和连接这些结点的链路(link)组成。
**互连网**(internetwork或internet)
可以通过路由器把网络互连起来，这就构成了一个覆盖范围更大的计算机网络，称之为互连网。
“网络的网络”(network of networks)。
![image-20200526205941615](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200526205941615.png)

**关于“云”**
当使用一朵“云”来表示网络时，可能会有两种不同的情况：
云表示的网络已经包含了和网络相连的计算机。
云表示的网络里面就只剩下许多路由器和连接这些路由器的链路，把有关的计算机画在云的外面。习惯上，与网络相连的计算机常称为主机(host)。

**网络**把许多计算机连接在一起。
**互连网**则把许多网络通过路由器连接在一起。
与网络相连的计算机常称为**主机**。

**1.2.2互联网基础结构发展的三个阶段**
**第一阶段：**从单个网络ARPANET向互联网发展的过程。
1983年，TCP/IP协议成为ARPANET上的标准协议，使得所有使用TCP/IP协议的计算机都能利用互连网相互通信。人们把1983年作为互联网的诞生时间。1990年，ARPANET正式宣布关闭。
**第二阶段**：建成了三级结构的互联网。
它是一个三级计算机网络，分为主干网、地区网和校园网（或企业网）。
![image-20200526210207015](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200526210207015.png)

**第三阶段**：逐渐形成了多层次ISP结构的互联网。
出现了互联网服务提供者ISP(Internet Service Provider)。
任何机构和个人只要向某个ISP交纳规定的费用，就可从该ISP获取所需IP地址的使用权，并可通过该ISP接入到互联网。
根据提供服务的覆盖面积大小以及所拥有的IP地址数目的不同，ISP也分成为不同层次的ISP：主干ISP、地区ISP和本地ISP。![image-20200526210304630](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200526210304630.png)

**互联网交换点IXP( Internet eXchange Point )**
互联网交换点IXP主要作用就是允许两个网络直接相连并交换分组
许多互联网交换点IXP在进行对等交换分组时互相不收取费用
但本地ISP或地区ISP通过IXP向高层的IXP转发分组需交纳一定费用
IXP采用工作在数据链路层的网络交换机都用局域网互连起来
到2016年3月，全球已经有226个IXP，分布在172个国家和地区。但互联网的发展在全世界还很不平衡。

**万维网WWW**
互联网已经成为世界上规模最大和增长速率最快的计算机网络，没有人能够准确说出互联网究竟有多大。
互联网的迅猛发展始于20世纪90年代。由欧洲原子核研究组织CERN开发的**万维网WWW  (World Wide Web)**被广泛使用在互联网上，大大方便了广大非网络专业人员对网络的使用，成为互联网的这种指数级增长的主要驱动力。

**1.2.3互联网的标准化工作**
互联网的标准化工作对互联网的发展起到了非常重要的作用。
![image-20200526210528323](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200526210528323.png)所有互联网标准都以 RFC 的形式在互联网上发表。
**Request For Comments (RFC）---请求评议**
互联网草案 (Internet Draft) ——有效期只有六个月。在这个阶段还*不是* RFC 文档。
建议标准 (Proposed Standard) ——从这个阶段开始就成为 RFC 文档。
互联网标准 (Internet Standard) ——达到正式标准后，每个标准就分配到一个编号 STD xxxx。一个标准可以和多个 RFC 文档关联。
**各种 RFC 之间的关系** 
除了建议标准和互联网标准这两种 RFC 文档外，还有三种 RFC 文档，即历史的、实验的和提供信息的 RFC 文档。![image-20200526211103863](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200526211103863.png)

## **1.3  互联网的组成**

**1.3.1  互联网的边缘部分**
从互联网的工作方式上看，可以划分为两大块：
**边缘部分**：由所有连接在互联网上的主机组成。这部分是用户直接使用的，用来进行通信（传送数据、音频或视频）和资源共享。
**核心部分**：由大量网络和连接这些网络的路由器组成。这部分是为边缘部分提供服务的（提供连通性和交换）。
![互联网的边缘部分与核心部分](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200526211243006.png)
边缘部分
处在互联网边缘的部分就是连接在互联网上的所有的主机。这些主机又称为端系统(end system)。
端系统在功能上可能有很大的差别
小的端系统可以是一台普通个人电脑，具有上网功能的智能手机，甚至是一个很小的网络摄像头。
大的端系统则可以是一台非常昂贵的大型计算机。
端系统的拥有者可以是个人，也可以是单位（如学校、企业、政府机关等），当然也可以是某个 ISP。

端系统之间通信的含义
“主机 A 和主机 B 进行通信”实际上是指：“运行在主机 A 上的某个程序和运行在主机 B 上的另一个程序进行通信”。简称为“计算机之间通信”。 

端系统之间的通信方式通常可划分为两大类：
客户-服务器方式（C/S 方式）
即 Client/Server 方式，简称为 C/S 方式。
对等方式（P2P 方式）
即 PeerToPeer 方式 ，简称为 P2P 方式。

**客户-服务器方式**
客户 (client) 和服务器 (server) 都是指通信中所涉及的两个应用进程。
客户-服务器方式所描述的是进程之间服务和被服务的关系。
客户是服务的请求方，服务器是服务的提供方。
服务请求方和服务提供方都要使用网络核心部分所提供的服务。
![image-20200526211804592](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200526211804592.png)
客户软件的特点:
被用户调用后运行，在打算通信时主动向远地服务器发起通信（请求服务）。因此，客户程序必须知道服务器程序的地址。
不需要特殊的硬件和很复杂的操作系统。
服务器软件的特点：
一种专门用来提供某种服务的程序，可同时处理多个远地或本地客户的请求。
系统启动后即自动调用并一直不断地运行着，被动地等待并接受来自各地的客户的通信请求。因此，服务器程序不需要知道客户程序的地址。
一般需要强大的硬件和高级的操作系统支持。
客户与服务器的通信关系建立后，通信可以是双向的，客户和服务器都可发送和接收数据。

**对等方式（P2P 方式）**
对等连接 (peer-to-peer，简写为 P2P) 是指两个主机在通信时并不区分哪一个是服务请求方还是服务提供方。
只要两个主机都运行了对等连接软件 (P2P 软件) ，它们就可以进行平等的、对等连接通信。
双方都可以下载对方已经存储在硬盘中的共享文档。
**特点**：
对等连接方式从本质上看仍然是使用客户服务器方式，只是对等连接中的每一个主机既是客户又是服务器。
例如主机 C 请求 D 的服务时，C 是客户，D 是服务器。但如果 C 又同时向 F提供服务，那么 C 又同时起着服务器的作用。
对等连接工作方式可支持大量对等用户（如上百万个）同时工作。
![image-20200526212026524](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200526212026524.png)



**1.3.2  互联网的核心部分**网络核心部分是互联网中最复杂的部分。
网络中的核心部分要向网络边缘中的大量主机提供连通性，使边缘部分中的任何一个主机都能够向其他主机通信（即传送或接收各种形式的数据）。
在网络核心部分起特殊作用的是**路由器 (router)**

**互联网的核心部分**
互联网的核心部分是由**许多网络**和把它们互连起来的路由器组成，而主机处在**互联网的边缘部分**。
互联网核心部分中的路由器之间一般都用高速链路相连接，而在网络边缘的主机接入到核心部分则通常以相对较低速率的链路相连接。
主机的用途是为用户进行信息处理的，并且可以和其他主机通过网络交换信息。路由器的用途则是用来转发分组的，即进行分组交换的。 

**路由器：**
在路由器中的输入和输出端口之间没有直接连线。
路由器处理分组的过程是：
把收到的分组先放入缓存（暂时存储）；
查找转发表，找出到某个目的地址应从哪个端口转发；
把分组送到适当的端口转发出去。

路由器是实现**分组交换 (packet switching)** 的关键构件，其任务是转发收到的分组，这是网络核心部分最重要的功能。
为了理解分组交换，首先了解计算机网络中常用的另外两种交换技术**电路交换、报文交换**的基本概念。

**1.** **电路交换**
2 部电话机只需要用 1 对电线直接连接就能够互相通话。
5 部电话机两两直接相连，需 10 对电线。
N 部电话机两两直接相连，需 N(N – 1)/2 对电线。这种直接连接方法所需要的电线对的数量与电话机数量的平方（ N2 ）成正比。
当电话机的数量增多时，就要使用**交换机**来完成全网的交换任务。
每一部电话都直接连接到交换机上，而交换机使用交换的方法，让电话用户彼此之间可以很方便地通信。
所采用的交换方式就是**电路交换 (circuit switching)**。
电路交换必定是**面向连接**的。
电路交换分为三个阶段：
**建立连接**：建立一条专用的物理通路，以保证双方通话时所需的通信资源在通信时不会被其他用户占用；
**通信**：主叫和被叫双方就能互相通电话；
**释放连接**：释放刚才使用的这条专用的物理通路（释放刚才占用的所有通信资源）。
优点：实时性好，能及时传达信息
缺点：
呼叫时间长
通信带宽不能充分利用，，这导致在传送计算机数据时，通信线路的利用率很低（用来传送数据的时间不到10%甚至1%）。
不同计算机和远程终端的传输速率不同

**2. 报文交换技术**
报文交换是采用存储转发的方式来传输数据，它不需要在两个站点之间建立一条专用的通信线路。
报文交换的特点是整块报文一起从一个站点传到另一个站点
优点：线路利用率较高，可共享信道；一个报文送到多个目的站点。
缺点：传输延迟长，不能满足实时或交互式通信要求。
报文交换的时延较长，从几分钟到几小时不等。现在报文交换已经很少有人使用了。

**3. 分组交换技术**

分组交换则采用存储转发技术。

1. 在发送端，先把较长的报文划分成较短的、固定长度的数据段。
2. 每一个数据段前面添加上首部构成分组(packet)。
   ![image-20200526212754007](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200526212754007.png)
3. 分组交换网以“分组”作为数据传输单元。
4. 依次把各分组发送到接收端（假定接收端在左边）。
   分组首部的重要性：
   **每一个**分组的首部都含有**地址**（诸如目的地址和源地址）等控制信息。
   分组交换网中的结点交换机根据收到的分组首部中的**地址信息**，把分组**转发**到下一个结点交换机。
   每个分组在互联网中**独立地选择传输路径**。
   用这样的**存储转发**方式，最后分组就能到达最终目的地。
5. 接收端收到分组后剥去首部还原成报文。
6. 最后，在接收端把收到的数据恢复成为原来的报文。
   这里我们假定分组在传输过程中没有出现差错，在转发时也没有被丢弃。

分组交换的优点
高效：在分组传输的过程中动态分配传输带宽，对通信链路是逐段占用。
灵活：为每一个分组独立地选择最合适的转发路由。
迅速：以分组作为传送单位，可以不先建立连接就能向其他主机发送分组。
可靠：保证可靠性的网络协议；分布式多路由的分组交换网，使网络有很好的生存性。

分组交换的缺点
分组在各结点存储转发时需要排队，这就会造成一定的时延。
分组必须携带的首部（里面有必不可少的控制信息）也造成了一定的开销。

**三种交换的比较**
![image-20200526213511182](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200526213511182.png)
若要连续传送大量的数据，且其传送时间远大于连接建立时间，则电路交换的传输速率较快。
报文交换和分组交换不需要预先分配传输带宽，在传送突发数据时可提高整个网络的信道利用率。
由于一个分组的长度往往远小于整个报文的长度，因此分组交换比报文交换的时延小，同时也具有更好的灵活性。

## 1.4  计算机网络在我国的发展

1980 年，铁道部开始进行计算机联网实验。
1989 年11 月，我国第一个公用分组交换网 CNPAC 建成运行。
**1994 年 4 月 20 日**，我国用 64 kbit/s 专线正式连入互联网，我国被国际上正式承认为接入互联网的国家。
1994 年 5 月，中国科学院高能物理研究所设立了我国的第一个万维网服务器。
1994 年 9 月中国公用计算机互联网  CHINANET 正式启动。

到目前为止，我国陆续建造了基于互联网技术的并能够和互联网互连的多个全国范围的公用计算机网络，其中规模最大的就是下面这五个：
(1) 中国电信互联网 CHINANET（也就是原来的中国公用计算机互联网）
(2) 中国联通互联网 UNINET
(3) 中国移动互联网 CMNET
(4) 中国教育和科研计算机网 CERNET
(5) 中国科学技术网 CSTNET

中国十大国内骨干互联网络
1.中国公用计算机互联网-----CHINANET
由中国电信集团主管，1994年8月原邮电部与美国Sprint公司签定协议，开始组建CHINANET网络，1995年6月正式提供服务。
2.中国科学技术网络--------CSTNET
由中国科学院主管，1994年5月21日完成**我国最高域名CN**主服务器的设置，实现了与Internet的TCP/IP连接。
3.中国教育和科研计算机网-----CERNET
由国家教育部主管，1994年开始建设，并于1995年10月开通，包括全国主干网、地区网、校园网的三级层次结构。（网络控制中心设在清华大学）
4.中国金桥信息网------------CHINAGBN
它是发展以地面光纤通信宽带传输系统为主的全新型电信业务网络。
**5.中国联通互联网**-----UNINET 1998年开始运营
6.中国网通宽带高速互联网----CNCNET    2000.10.28年开始运营
**7.中国移动互联网**--------CMNET  2000.1开始运营
8.中国国际经济贸易互联网----CIETNET
我国唯一的经济类国际互联网络，2000年初开始组建
9.中国长城互联网-------CGWNET  正在建设中
公益性网络
10.中国卫星集团互联网----CSNET  正在建设中

## 1.5  计算机网络的类别

**1.5.1  计算机网络的定义**
1、最简单的定义：计算机网络是一些互相连接的、自治的计算机的集合。
2、因特网(Internet)是“网络的网络”
3、较好的定义：所谓的计算机网络就是把分布在不同区域的计算机与专门的设备用通信线路互相连成一个规模大、功能强的网络系统，从而使众多计算机可以方便地互相传递信息、共享硬件、软件、数据信息资源等的系统。

**1.5.2  几种不同类别的网络**
计算机网络有多种类别。典型包括：

1. 按照网络的作用范围进行分类
2. 按照网络的使用者进行分类
3. 用来把用户接入到互联网的网络

1.按照网络的作用范围进行分类
**广域网 WAN** (Wide Area Network)：作用范围通常为几十到几千公里。
**城域网 MAN** (Metropolitan Area Network)：作用距离约为  5 ~ 50 公里。
**局域网 LAN** (Local Area Network) ：局限在较小的范围（如 1 公里左右）。
**个人区域网 PAN** (Personal Area Network) ：范围很小，大约在 10 米左右。

2.按照网络的使用者进行分类
公用网 (public network) 
按规定交纳费用的人都可以使用的网络。因此也可称为公众网。
专用网 (private network) 
为特殊业务工作的需要而建造的网络。
公用网和专用网都可以提供多种服务。如传送的是计算机数据，则分别是公用计算机网络和专用计算机网络。

3.用来把用户接入到互联网的**网络接入网 AN** (Access Network)，它又称为本地接入网或居民接入网。
接入网是一类比较特殊的计算机网络，用于将用户接入互联网。
接入网本身既不属于互联网的核心部分，也不属于互联网的边缘部分。
接入网是从某个用户端系统到互联网中的第一个路由器（也称为边缘路由器）之间的一种网络。

## 1.6  计算机网络的性能

**1.6.1  计算机网络的性能指标**
计算机网络的性能一般是指它的几个重要的性能指标，主要包括：
**速率、带宽、吞吐量、时延**、时延带宽积、往返时间 RTT、利用率

1. 速率

   比特（bit）是计算机中数据量的单位，也是信息论中使用的信息量的单位。
   比特（bit）来源于 binary digit，意思是一个“二进制数字”，因此一个比特就是二进制数字中的一个 1 或 0。
   速率是计算机网络中最重要的一个性能指标，指的是**数据的传送速率**，它也称为**数据率** (data rate)或**比特率** (bit rate)。
   速率的单位是 bit/s，或 kbit/s、Mbit/s、 Gbit/s 等。例如 4 * 10^10 bit/s 的数据率就记为 40 Gbit/s。
   *速率往往是指额定速率或标称速率，非实际运行速率。*

2. 带宽 
   两种不同意义：
   “带宽”(bandwidth) 本来是指信号具有的**频带宽度**，其单位是赫（或千赫、兆赫、吉赫等）。
   在计算机网络中，带宽用来表示网络中某通道传送数据的能力。表示在单位时间内网络中的某信道所能通过的“**最高数据率**”。单位是 bit/s ，即 “比特每秒”。
   在时间轴上信号的宽度随带宽的增大而变窄。

   ![image-20200527113034456](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200527113034456.png)

3. 吞吐量
   吞吐量 (throughput) 表示在单位时间内通过某个网络（或信道、接口）的数据量。
   吞吐量更经常地用于对现实世界中的网络的一种测量，以便知道实际上**到底有多少数据量能够通过网络**。
   吞吐量受网络的带宽或网络的额定速率的限制。

4. 时延
   时延 (delay 或 latency) 是指数据（一个报文或分组，甚至比特）从网络（或链路）的一端传送到另一端所需的时间。
   有时也称为**延迟或迟延**。
   数据在网络中经历的总时延就是发送时延、传播时延、处理时延和排队时延之和。
   网络中的时延由以下几个不同的部分组成：
   (1)发送时延
   也称为传输时延。
   发送数据时，数据帧从结点进入到传输媒体所需要的时间。
   也就是从发送数据帧的第一个比特算起，到该帧的最后一个比特发送完毕所需的时间。
   发送时延=数据帧长度（bit）/发送速率（bit/s）

   (2)传播时延
   电磁波在信道中需要传播一定的距离而花费的时间。
   **发送时延与传播时延有本质上的不同。**
   信号**发送速率**和信号在信道上的传播速率是**完全不同**的概念。
   传播时延=信道长度（米）/信号在信道上的传播速率（米/秒）

   (3)处理时延
   主机或路由器在收到分组时，为处理分组（例如分析首部、提取数据、差错检验或查找路由）所花费的时间。

   (4)排队时延
   分组在路由器输入输出队列中排队**等待处理**所经历的时延。
   *排队时延的长短往往取决于网络中当时的通信量。*

5. 时延带宽积
   链路的时延带宽积又称为**以比特为单位的链路长度**。
   时延带宽积=传播时延*带宽
   只有在代表链路的管道都充满比特时，
   链路才得到了充分利用。

6. 往返时间RTT
   互联网上的信息不仅仅单方向传输，而是双向交互的。因此，有时很需要知道双向交互一次所需的时间。
   **往返时间**表示从发送方发送数据开始，到发送方收到来自接收方的确认，总共经历的时间。
   在互联网中，往返时间还包括**各中间结点**的处理时延、排队时延以及转发数据时的发送时延。
   当使用卫星通信时，往返时间 RTT 相对较长，是很重要的一个性能指标。

7. 利用率
   分为信道利用率和网络利用率。
   **信道利用率**指出某信道有百分之几的时间是被利用的（有数据通过）。完全空闲的信道的利用率是零。
   **网络利用率则**是全网络的信道利用率的加权平均值。
   信道利用率并非越高越好。*当某信道的利用率增大时，该信道引起的时延也就迅速增加。*

**1.6.2  计算机网络的非性能特征**
一些非性能特征也很重要。它们与前面介绍的性能指标有很大的关系。主要包括：
费用、质量、标准化、可靠性、可扩展性和可升级性、易于管理和维护

## 1.7  计算机网络的体系结构

**1.7.1  计算机网络体系结构的形成**
相互通信的两个计算机系统必须**高度协调工作**才行，而这种“协调”是相当复杂的。
“**分层**”可将庞大而复杂的问题，转化为若干较小的局部问题，而这些较小的局部问题就比较易于研究和处理。

计算机网络的**体系结构**(architecture)是计算机网络的各层及其协议的集合。
体系结构就是这个计算机网络及其部件所应完成的功能的**精确定义**。
**实现**(implementation)是遵循这种体系结构的前提下用何种硬件或软件完成这些功能的问题。
体系结构是抽象的，而实现则是具体的，是真正在运行的计算机硬件和软件。
**世界上第一个网络体系结构**是IBM公司与1974年提出的“SNA”。

**计算机网络的根本目的**是为了实现数据通信和软件、硬件资源共享，要想让两台计算机进行通信，必须采用相同的信息交换规则，这就是**网络协议**。
相互通信的两个计算机系统必须高度协调工作才行，而这种“协调”是相当复杂的。
要真正理解网络体系结构，我们先必须知道下面几个概念：**协议、实体、系统、层、接口**等

网络层次体系结构主要包括五个要素
1.网络协议
网络协议 (network protocol)，简称为协议，是为网络中的数据交换而建立的**规则、标准或约定的集合**。
语法：数据与控制信息的结构或格式。
语义：需要发出何种控制信息，完成何种动作以及做出何种响应。
同步：事件实现顺序的详细说明。
2.实体
软件元素（如进程等）或硬件元素（智能I/O芯片等）的抽象。
3.系统
包含一个或多个实体，具有信息处理和通信功能的整体。通常一个系统总是硬件、软件两部分的有机结合。
4.层：层是处理复杂问题的一种结构化技术。上层只知道下层为其提供哪些服务，并不关心这些服务是如何实现的
5.接口：同一结点的不同功能层之间的通信规则。（服务访问点SAP）
注意:
协议是“水平的”，即协议是控制对等实体之间通信的规则。
服务是“垂直的”，即服务是由下层向上层通过层间接口提供。
同一系统相邻两层的实体进行交互的地方，称为服务访问点 SAP  (Service Access Point)。

1974 年，美国的 IBM 公司宣布了**系统网络体系结构SNA** (System Network Architecture)。这个著名的网络标准就是按照分层的方法制定的。
不久后，其他一些公司也相继推出自己公司的具有不同名称的体系结构。
由于**网络体系结构的不同**，不同公司的设备很难互相连通。

1、开放系统互连参考模型 OSI/RM
为了使不同体系结构的计算机网络都能互连，国际标准化组织 ISO 于 1977 年成立了专门机构研究该问题。
他们提出了一个试图使各种计算机在世界范围内互连成网的标准框架，即著名的**开放系统互连基本参考模型 OSI/RM** (Open Systems Interconnection Reference Model)，简称为 OSI。
只要遵循 OSI 标准，一个系统就可以和位于世界上任何地方的、也遵循这同一标准的其他任何系统进行通信。
开放系统互连基本参考模型 OSI/RM七层：
**物理层、数据链路层、网络层、传输层、会话层、表示层、应用层。**

2、TCP /IP参考模型TCP/IP 是四层的体系结构：
应用层、运输层、网际层、网络接口层

法律上的 (de jure) 国际标准 OSI 并没有得到市场的认可。
非国际标准 TCP/IP 却获得了最广泛的应用。TCP/IP 常被称为事实上的 (de facto) 国际标准。

**1.7.2  协议与划分层次**
计算机网络中的数据交换**必须遵守事先约定好的规则**。
这些规则明确规定了所交换的数据的格式以及有关的同步问题（同步含有时序的意思）。
**网络协议** (network protocol)，简称为**协议**，是为进行网络中的数据交换而建立的规则、标准或约定。
语法：数据与控制信息的结构或格式。
语义：需要发出何种控制信息，完成何种动作以及做出何种响应。
同步：事件实现顺序的详细说明。

分层的好处：
各层之间是独立的、灵活性好、结构上可分割开、易于实现和维护、能促进标准化工作。
缺点：降低效率、有些功能会在不同的层次中重复出现，因而产生了额外开销。

**1.7.3具有五层协议的体系结构**
OSI的七层协议体系结构的概念清楚，理论也较完整，但它既复杂又不实用。
TCP/IP是四层体系结构：应用层、运输层、网际层和网络接口层。
但最下面的网络接口层并没有具体内容。
因此往往采取折中的办法，即综合 OSI 和 TCP/IP 的优点，采用一种只有**五层协议的体系结构**。

![image-20200527115808249](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200527115808249.png)
![image-20200527121242977](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200527121242977.png)**主机 1 向主机 2 发送数据**
1.应用进程数据先传送到应用层，加上应用层首部，成为应用层PDU
2.应用层 PDU 再传送到运输层，加上运输层首部，成为运输层报文
3.运输层报文再传送到网络层，加上网络层首部，成为 IP 数据报（或分组）
4.IP 数据报再传送到数据链路层，加上链路层首部和尾部，成为数据链路层帧
5.数据链路层帧再传送到物理层，最下面的物理层把比特流传送到物理媒体
电信号（或光信号）在物理媒体中传播，从发送端物理层传送到接收端物理层
1.物理层接收到比特流，上交给数据链路层
2.数据链路层剥去帧首部和帧尾部，取出数据部分，上交给网络层
3.网络层剥去首部，取出数据部分，上交给运输层
4.运输层剥去首部，取出数据部分，上交给应用层
5.应用层剥去首部，取出应用程序数据，上交给应用进程

PDU (Protocol Data Unit)：协议数据单元。OSI 参考模型把对等层次之间传送的数据单位称为该层的协议数据单元 PDU。
OSI 参考模型把对等层次之间传送的数据单位称为该层的**协议数据单元 PDU** (Protocol Data Unit)。这个名词现已被许多非 OSI 标准采用。
任何两个同样的层次把数据（即数据单元加上控制信息）通过水平虚线直接传递给对方。这就是所谓的“**对等层**”(peer layers)之间的通信。
**各层协议**实际上就是在各个对等层之间传递数据时的各项规定。

**1.7.4  实体、协议、服务和服务访问点**
**实体** (entity) 表示任何可发送或接收信息的硬件或软件进程。
**协议**是控制两个对等实体进行通信的规则的集合。
在协议的控制下，两个对等实体间的通信使得本层能够向上一层提供服务。
要实现本层协议，还需要使用下层所提供的服务。

协议和服务在概念上是不一样的
协议的实现保证了能够向上一层提供服务。
本层的服务用户**只能看见服务**而无法看见下面的协议。即下面的协议对上面的服务用户是**透明**的。
协议是“**水平的**”，即协议是控制对等实体之间通信的规则。
服务是“**垂直的**”，即服务是由下层向上层通过层间接口提供的。
上层使用**服务原语**获得下层所提供的服务。

同一系统相邻两层的实体进行交互的地方，称为**服务访问点SAP** (Service Access Point)。
服务访问点SAP是一个抽象的概念，它实际上就是一个逻辑接口。

协议必须把所有不利的条件事先都估计到，而不能假定一切都是正常的和非常理想的。
看一个计算机网络协议是否正确，不能光看在正常情况下是否正确，还必须非常仔细地检查这个协议能否应付各种异常情况。

**1.7.5  TCP/IP 的体系结构**
![image-20200527122707842](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200527122707842.png)
TCP/IP 是四层体系结构
TCP/IP 体系结构的另一种表示方法
实际上，现在的互联网使用的 TCP/IP 体系结构有时已经发生了演变，即某些应用程序可以直接使用 IP 层，或甚至直接使用最下面的网络接口层。
![image-20200527122804845](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200527122804845.png)
![image-20200527122820330](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200527122820330.png)

# 2.物理层

物理层的四个基本特性
物理层下面的传输媒体：**双绞线和光纤**
常见的几种信道复用技术
**宽带接入技术：ADSL和FTTx**

## 2.1  物理层的基本概念

物理层考虑的是怎样才能在连接各种计算机的传输媒体上**传输数据比特流**，而不是指具体的传输媒体。
物理层的作用是要尽可能地屏**蔽掉**不同传输媒体和通信手段的差异。
用于物理层的协议也常称为物理层**规程(procedure)**。

物理层的主要任务：确定与传输媒体的接口的一些特性。
**机械特性**：指明接口所用接线器的形状和尺寸、引线数目和排列、固定和锁定装置等。
**电气特性**：指明在接口电缆的各条线上出现的电压的范围。
**功能特性**：指明某条线上出现的某一电平的电压表示何种意义。
**过程特性**：指明对于不同功能的各种可能事件的出现顺序。

## 2.2  数据通信的基础知识

**2.2.1  数据通信系统的模型**
一个数据通信系统包括三大部分：源系统（或发送端、发送方）、传输系统（或传输网络）和目的系统（或接收端、接收方）。
![image-20200528134925904](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200528134925904.png)

常用术语：
**数据**(data)——运送消息的实体。
**信号**(signal)——数据的电气的或电磁的表现。
**模拟信号**(analogous signal)——代表消息的参数的取值是连续的。
**数字信号**(digital signal)——代表消息的参数的取值是离散的。
**码元**(code)——在使用时间域（或简称为时域）的波形表示数字信号时，代表不同离散数值的基本波形。

**2.2.2  有关信道的几个基本概念**
**信道**——一般用来表示向某一个方向传送信息的媒体。
单向通信（单工通信）——只能有一个方向的通信而没有反方向的交互。
双向交替通信（半双工通信）——通信的双方都可以发送信息，但不能双方同时发送(当然也就不能同时接收)。
双向同时通信（全双工通信）——通信的双方可以同时发送和接收信息。
**基带信号**（即基本频带信号）——来自信源的信号。像计算机输出的代表各种文字或图像文件的数据信号都属于基带信号。基带信号往往包含有较多的低频成分，甚至有直流成分，而许多信道并不能传输这种低频分量或直流分量。因此必须对基带信号进行**调制(modulation)**。

调制分为两大类：
**基带调制**：仅对基带信号的波形进行变换，使它能够与信道特性相适应。变换后的信号**仍然是基带信号**。把这种过程称为**编码(coding)**。
**带通调制**：使用**载波(carrier)**进行调制，把基带信号的频率范围搬移到较高的频段，并**转换为模拟信号**，这样就能够更好地在模拟信道中传输（即仅在一段频率范围内能够通过信道）。

(1)常用编码方式
**不归零制：**正电平代表1，负电平代表0。
**归零制**：正脉冲代表1，负脉冲代表0。
**曼彻斯特编码**：位周期中心的向上跳变代表0，位周期中心的向下跳变代表1。但也可反过来定义。
**差分曼彻斯特编码**：在每一位的中心处始终都有跳变。位开始边界有跳变代表0，而位开始边界没有跳变代表1。![image-20200528135403477](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200528135403477.png)
(2)基本的带通调制方法
基带信号往往包含有较多的低频成分，甚至有直流成分，而许多信道并不能传输这种低频分量或直流分量。为了解决这一问题，就必须对基带信号进行**调制(modulation)**。
最基本的二元制调制方法有以下几种：
**调幅(AM)**：载波的振幅随基带数字信号而变化。
**调频(FM)**：载波的频率随基带数字信号而变化。
**调相(PM)**：载波的初始相位随基带数字信号而变化。
![image-20200528135510532](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200528135510532.png)

**2.2.3  信道的极限容量**
任何实际的信道都不是理想的，在传输信号时会产生各种失真以及带来多种干扰。
码元传输的速率越高，或信号传输的距离越远，或传输媒体质量越差，在信道的输出端的波形的失真就越严重。
![image-20200528135558649](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200528135558649.png)

从概念上讲，限制码元在信道上的传输速率的因素有以下两个：
信道能够通过的频率范围、信噪比
**(1)信道能够通过的频率范围**
具体的信道所能通过的频率范围总是有限的。信号中的许多高频分量往往不能通过信道。
1924年，奈奎斯特(Nyquist)就推导出了著名的**奈氏准则**。他给出了在假定的理想条件下，为了避免**码间串扰**，码元的传输速率的上限值。
**公式：C=2Wlog2N**
（其中的W为带宽，N为周期内传输码元的个数。）
在任何信道中，码元传输的速率是有上限的，否则就会出现码间串扰的问题，使接收端对码元的判决（即识别）成为不可能。
如果信道的频带越宽，也就是能够通过的信号高频分量越多，那么就可以用更高的速率传送码元而不出现码间串扰。

**(2)信噪比**
噪声存在于所有的电子设备和通信信道中。
噪声是随机产生的，它的瞬时值有时会很大。因此噪声会使接收端对码元的判决产生错误。
但噪声的影响是相对的。如果信号相对较强，那么噪声的影响就相对较小。
信噪比就是**信号的平均功率和噪声的平均功率之比**。常记为S/N，并用分贝(dB)作为度量单位。即：
		**信噪比(dB)=10 log10(S/N)    (dB)**
例如，当S/N=10时，信噪比为10dB，而当S/N=1000时，信噪比为30dB。
1984年，香农(Shannon)用信息论的理论推导出了带宽受限且有高斯白噪声干扰的信道的极限、无差错的信息传输速率（香农公式）。
信道的极限信息传输速率C可表达为：
		**C = W log2(1+S/N)    (bit/s)**
其中：	
		W为信道的带宽（以Hz为单位）；
		S为信道内所传信号的平均功率；
		N为信道内部的高斯噪声功率。
香农公式表明
信道的带宽或信道中的信噪比越大，则信息的极限传输速率就越高。
*只要信息传输速率低于信道的极限信息传输速率，就一定可以找到某种办法来实现无差错的传输。*
*若信道带宽W或信噪比S/N没有上限（当然实际信道不可能是这样的），则信道的极限信息传输速率C也就没有上限。*
实际信道上能够达到的信息传输速率要比香农的极限传输速率低不少。

## 2.3  物理层下面的传输媒体

传输媒体也称为**传输介质**或**传输媒介**，它就是数据传输系统中在发送器和接收器之间的物理通路。
传输媒体可分为两大类，即导引型传输媒体和非导引型传输媒体。
在**导引型传输媒体**中，电磁波被导引沿着固体媒体（铜线或光纤）传播。
**非导引型传输媒体**就是指自由空间。在非导引型传输媒体中，电磁波的传输常称为无线传输。
电信领域使用的电磁波的频谱：
![image-20200528151652218](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200528151652218.png)

**2.3.1导引型传输媒体**
**双绞线**：
最常用的传输媒体。
模拟传输和数字传输都可以使用双绞线，其通信距离一般为几到十几公里。
**屏蔽双绞线STP(Shielded Twisted Pair)**
**无屏蔽双绞线UTP(Unshielded Twisted Pair)**
（1）非屏蔽双绞线（UTP）
![image-20200528151824825](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200528151824825.png)
（2）屏蔽双绞线（STP）
屏蔽双绞线（Shielded Twisted Pair，STP）使用金属箔或金属网包裹网线内部的信号线，在屏蔽层外面再包裹绝缘外皮。
根据屏蔽方式的不同，屏蔽双绞线又分为：
STP（Shielded Twisted-Pair）：是指每条线对都有各自屏蔽层。
FTP（Foil Twisted-Pair）：是所有线对采用整体屏蔽。
![image-20200528151843618](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200528151843618.png)
双绞线标准
1991年，美国电子工业协会EIA和电信行业协会联合发布了一个用于室内传送数据的无屏蔽双绞线和屏蔽双绞线的标准EIA/TIA-568。
1995年将布线标准更新为EIA/TIA-568-A。
2001年，EIA/TIA-568发布了第三个版本，即EIA/TIA-568-B
此标准规定了5个种类的UTP标准（从1类线到5类线）。
对传送数据来说，现在最常用的UTP是5类线（Category 5或CAT5）。
![image-20200528151921236](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200528151921236.png)
双绞线**EIA/TIA-568-B标准**
现阶段最新**EIA/TIA-568-B排线顺序**：
接线方式规定如下：
    1、2用于发送，3、6用于接收，4、5，7、8是双向线。
    1、2线必须是双绞，3、6双绞，4、5双绞，7、8双绞。
正确接线顺序：
        1        2       3       4       5       6       7       8
      白橙、橙、白绿、蓝、蓝白、绿、白棕、棕

**同轴电缆**
同轴电缆具有很好的抗干扰特性，被广泛用于传输较高速率的数据。
同轴电缆的带宽取决于电缆的质量。
50Ω同轴电缆——LAN/数字传输常用
75Ω同轴电缆——有线电视/模拟传输常用
![image-20200528152235333](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200528152235333.png)

**光缆**
光纤是光纤通信的传输媒体。
由于可见光的频率非常高，约为108MHz的量级，因此一个光纤通信系统的传输带宽远远大于目前其他各种传输媒体的带宽。
![image-20200528152301664](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200528152301664.png)
当光线从高折射率的媒体射向低折射率的媒体时，其折射角将大于入射角。因此，如果入射角足够大，就会出现全反射，光也就沿着光纤传输下去。

**多模光纤**：可以存在多条不同角度入射的光线在一条光纤中传输。这种光纤就称为多模光纤。
**单模光纤**：若光纤的直径减小到只有一个光的波长，则光纤就像一根波导那样，它可使光线一直向前传播，而不会产生多次反射。这样的光纤称为单模光纤。
光纤通信中使用的光波的波段
常用的三个波段的中心分别位于850nm,1300nm和1550nm。
所有这三个波段都具有25000~30000GHz的带宽，可见光纤的通信容量非常大。
**光纤优点**
(1)通信容量非常大。
(2)传输损耗小，中继距离长。
(2)抗雷电和电磁干扰性能好。
(3)无串音干扰，保密性好。
(4)体积小，重量轻。

**2.3.2  非导引型传输媒体**
将自由空间称为“非导引型传输媒体”。
无线传输所使用的频段很广。
**短波通信**（即高频通信）主要是靠电离层的反射，但短波信道的通信质量较差，传输速率低。
**微波**在空间主要是直线传播。
传统微波通信有两种方式：地面微波接力通信、卫星通信

## 2.4  信道复用技术

**2.4.1  频分复用**(Frequency Division Multiplexing)
**复用(multiplexing)**是通信技术中的基本概念。
它允许用户使用一个**共享**信道进行通信，降低成本，提高利用率。
![image-20200528152721485](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200528152721485.png)
将整个带宽分为多份，用户在分配到一定的频带后，在通信过程中自始至终都占用这个频带。
**频分复用**的所有用户在同样的时间**占用不同的带宽资源**（请注意，这里的“带宽”是频率带宽而不是数据的发送速率）。
![image-20200528152901270](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200528152901270.png)

**2.4.2时分复用和统计时分复用**
**时分复用**则是将时间划分为一段段等长的**时分复用帧**（TDM帧）。每一个时分复用的用户在每一个TDM帧中占用固定序号的时隙。
每一个用户所占用的时隙是**周期性地出现**（其周期就是TDM帧的长度）。
TDM信号也称为**等时**(isochronous)信号。
时分复用的所有用户是在**不同的时间**占用**同样的频带宽度**。
![image-20200528152917172](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200528152917172.png)
**时分复用可能会造成线路资源的浪费**：使用时分复用系统传送计算机数据时，由于计算机数据的突发性质，用户对分配到的子信道的利用率一般是不高的。
![image-20200528153033388](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200528153033388.png)
**统计时分复用STDM(Statistic TDM)**
![image-20200528153223274](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200528153223274.png)

**2.4.3  波分复用**WDM(Wavelength Division Multiplexing)
![image-20200528153319374](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200528153319374.png)



**2.4.4  码分复用**CDM(Code Division Multiplexing)
常用的名词是**码分多址**CDMA (Code Division Multiple Access)。
各用户使用经过特殊挑选的不同码型，因此彼此不会造成干扰。
这种系统发送的信号有很强的抗干扰能力，其频谱类似于白噪声，不易被敌人发现。

码片序列(chip sequence)
每一个比特时间划分为m个短的间隔，称为**码片(chip)**。
每个站被指派一个唯一的m bit码片序列。
如发送比特1，则发送自己的m bit码片序列。
如发送比特0，则发送该码片序列的二进制反码。
例如，S站的8 bit码片序列是00011011。
发送比特1时，就发送序列00011011，
发送比特0时，就发送序列11100100。
S站的码片序列：(–1–1–1+1+1–1+1+1)

## 2.5  数字传输系统

在早期电话网中，从市话局到用户电话机的用户线是采用最廉价的双绞线电缆，而长途干线采用的是频分复用FDM的模拟传输方式。
与模拟通信相比，数字通信无论是在传输质量上还是经济上都有明显的优势。
目前，长途干线大都采用时分复用PCM的数字传输方式。
脉码调制PCM体制最初是为了在电话局之间的中继线上传送多路的电话。

由于历史上的原因，PCM有两个互不兼容的国际标准：
北美的24路PCM（简称为T1）
欧洲的30路PCM（简称为E1）
我国采用的是欧洲的E1标准。
E1的速率是2.048Mbit/s，而T1的速率是1.544Mbit/s。
当需要有更高的数据率时，可采用复用的方法

旧的数字传输系统存在许多**缺点**，最主要的是以下两个方面：
**速率标准不统一**
如果不对高次群的数字传输速率进行标准化，国际范围的基于光纤高速数据传输就很难实现。
**不是同步传输**
在过去相当长的时间，为了节约经费，各国的数字网主要是采用准同步方式。
当数据传输的速率很高时，收发双方的时钟同步就成为很大的问题。

**同步光纤网** SONET (Synchronous Optical Network)
同步光纤网的各级时钟都来自一个非常精确的主时钟。
SONET为光纤传输系统定义了同步传输的线路速率等级结构
对电信信号称为第1级**同步传送信号**STS-1(Synchronous Transport Signal)，其传输速率是51.84 Mbit/s。
对光信号则称为第1级**光载波**OC-1(OC表示Optical Carrier)。
现已定义了从51.84 Mbit/s (即OC-1)一直到 9953.280 Mbit/s (即 OC-192/STS-192) 的标准。

**同步数字系列** SDH (Synchronous Digital Hierarchy)
ITU-T 以美国标准 SONET 为基础，制订出国际标准同步数字系列 。
一般可认为 SDH 与 SONET 是同义词。
其主要**不同点**是：SDH 的基本速率为 155.52 Mbit/s，称为第 1 级同步传递模块 (Synchronous Transfer Module)，即 STM-1，相当于 SONET 体系中的 OC-3 速率。   

SONET / SDH 标准的意义
使不同的数字传输体制在 STM-1 等级上获得了统一。
第一次真正实现了数字传输体制上的世界性标准。
已成为公认的新一代理想的传输网体制。
SDH 标准也适合于微波和卫星传输的技术体制。

## 2.6  宽带接入技术

用户要连接到互联网，必须先连接到某个ISP。
在互联网的发展初期，用户都是利用电话的用户线通过调制解调器连接到ISP的，电话用户线接入到互联网的速率最高只能达到56kbit/s。
美国联邦通信委员会FCC认为只要双向速率之和超过200kbit/s就是**宽带**。
从宽带接入的媒体来看，可以划分为两大类：有线宽带接入、无线宽带接入。
下面讨论有线的宽带接入。

**2.6.1  ADSL 技术**
**非对称数字用户线**ADSL(Asymmetric Digital Subscriber Line)技术就是用数字技术对现有的模拟电话用户线进行改造，使它能够承载宽带业务。
标准模拟电话信号的频带被限制在300~3400Hz的范围内，但用户线本身实际可通过的信号频率仍然超过1MHz。
ADSL技术就把0~4kHz低端频谱留给传统电话使用，而*把原来没有被利用的高端频谱留给用户上网使用。*
DSL就是**数字用户线**(Digital Subscriber Line)的缩写。
DSL的几种类型：
**ADSL**(Asymmetric Digital Subscriber Line)：非对称数字用户线
**HDSL**(High speed DSL)：高速数字用户线
**SDSL**(Single-line DSL)：1对线的数字用户线
**VDSL**(Very high speed DSL)：甚高速数字用户线
**DSL**(Digital Subscriber Line)：数字用户线。
**RADSL**(Rate-Adaptive DSL)：速率自适应DSL，是ADSL的一个子集，可自动调节线路速率）。
**ADSL的传输距离：**
ADSL的传输距离取决于**数据率和用户线的线径**（用户线越细，信号传输时的衰减就越大）。
ADSL所能得到的最高数据传输速率与实际的用户线上的信噪比密切相关。
例如：
0.5 毫米线径的用户线，传输速率为 1.5 ~ 2.0 Mbit/s 时可传送 5.5 公里，但当传输速率提高到 6.1 Mbit/s 时，传输距离就缩短为 3.7 公里。
如果把用户线的线径减小到 0.4 毫米，那么在 6.1 Mbit/s 的传输速率下就只能传送 2.7 公里。
**ADSL** **的特点**：
上行和下行带宽做成不对称的。上行指从用户到 ISP，而下行指从 ISP 到用户。
ADSL 在用户线（铜线）的两端各安装一个 **ADSL 调制解调器**。
我国目前采用的方案是**离散多音调 DMT** (Discrete Multi-Tone)调制技术。这里的“多音调”就是“多载波”或“多子信道”的意思。
**ADSL 的数据率：**
由于用户线的具体条件往往相差很大（距离、线径、受到相邻用户线的干扰程度等都不同），因此 ADSL 采用**自适应调制技术**使用户线能够传送尽可能高的数据率。
当 ADSL 启动时，用户线两端的 ADSL 调制解调器就测试可用的频率、各子信道受到的干扰情况，以及在每一个频率上测试信号的传输质量。
**ADSL 不能保证固定的数据率**。对于质量很差的用户线甚至无法开通 ADSL。
通常下行数据率在 32 kbit/s 到 6.4 Mbit/s 之间，而上行数据率在 32 kbit/s 到 640 kbit/s 之间。
**ADSL 的组成：**
![image-20200528155913377](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200528155913377.png)
**第二代 ADSL**：
包括 ADSL2（G.992.3 和 G.992.4）和 ADSL2+（G.992.5）
通过提高调制效率得到了**更高的数据率**。
ADSL2 要求至少应支持下行 8 Mbit/s、上行 800 kbit/s的速率。
ADSL2+ 则将频谱范围从 1.1 MHz 扩展至 2.2 MHz，下行速率可达 16 Mbit/s（最大传输速率可达 25 Mbit/s），而上行速率可达 800 kbit/s。
采用了**无缝速率自适应技术** SRA (Seamless Rate Adaptation)，可在运营中不中断通信和不产生误码的情况下，自适应地调整数据率。
改善了线路质量评测和故障定位功能，这对提高网络的运行维护水平具有非常重要的意义。

**DMT 技术**(Discrete Multi-Tone)
**离散多音调 DMT** 调制技术采用**频分复用**的方法，把 40 kHz 以上一直到 1.1 MHz 的高端频谱划分为许多的子信道，其中 25 个子信道用于上行信道，而 249 个子信道用于下行信道。
每个子信道占据 4 kHz 带宽（严格讲是 4.3125 kHz），并使用不同的载波（即不同的音调）进行数字调制。这种做法相当于在一对用户线上使用许多小的调制解调器**并行**地传送数据。
DMT 技术的频谱分布
![image-20200528155741604](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200528155741604.png)

**2.6.2  光纤同轴混合网（HFC网）**
HFC (Hybrid Fiber Coax) 网是在目前覆盖面很广的有线电视网 CATV 的基础上开发的一种居民宽带接入网。
HFC 网除可传送 CATV 外，还提供电话、数据和其他宽带交互型业务。
现有的 CATV 网是树形拓扑结构的同轴电缆网络，它采用模拟技术的频分复用对电视节目进行单向传输。
**HFC 网对 CATV 网进行了改造。** 

HFC 网的主干线路采用光纤
HFC 网将原 CATV 网中的同轴电缆主干部分改换为**光纤**，并使用**模拟光纤技术**。
在模拟光纤中采用**光的振幅调制** AM，这比使用数字光纤更为经济。
模拟光纤从**头端**连接到**光纤结点** (fiber node)，即光**分配结点** ODN (Optical Distribution Node)。在光纤结点光信号被转换为电信号。在光纤结点以下就是同轴电缆。
HFC 网采用结点体系结构
![image-20200528160237104](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200528160237104.png)
HFC 网具有双向传输功能，扩展了传输频带
![image-20200528160254030](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200528160254030.png)
每个家庭要安装一个用户接口盒
**用户接口盒 UIB** (User Interface Box) 要提供三种连接，即：
使用同轴电缆连接到机顶盒 (set-top box)，然后再连接到用户的电视机。
使用双绞线连接到用户的电话机。
使用电缆调制解调器连接到用户的计算机。

**电缆调制解调器** (Cable Modem)
电缆调制解调器是为 HFC 网而使用的调制解调器。
电缆调制解调器最大的特点就是传输速率高。
下行速率一般在 3 ~ 10 Mbit/s之间，最高可达 30 Mbit/s。
上行速率一般为 0.2 ~ 2 Mbit/s，最高可达 10 Mbit/s。
电缆调制解调器比在普通电话线上使用的调制解调器要复杂得多，并且不是成对使用，而是只安装在用户端。 

**2.6.3  FTTx 技术**
FTTx 是一种实现宽带居民接入网的方案，代表多种宽带光纤接入方式。
FTTx 表示 Fiber To The…（光纤到…），例如：
**光纤到户 FTTH** (Fiber To The Home)：光纤一直铺设到用户家庭，可能是居民接入网最后的解决方法。
**光纤到大楼 FTTB** (Fiber To The Building)：光纤进入大楼后就转换为电信号，然后用电缆或双绞线分配到各用户。
**光纤到路边 FTTC** (Fiber To The Curb)：光纤铺到路边，从路边到各用户可使用星形结构双绞线作为传输媒体。
无源光网络 PON(Passive Optical Network) 的组成

![无源光网络 PON(Passive Optical Network)的组成](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200528160444210.png)

# 3.数据链路层

**本章重点**：
数据链路层的三个基本功能：**封装成帧、透明传输、差错检测**
点对点协议 PPP
 以太网MAC层的硬件地址
 交换机的工作原理
 扩展的以太网：虚拟局域网技术

数据链路层使用的信道主要有以下两种类型：
**点对点信道**：这种信道使用一对一的点对点通信方式。
**广播信道**：这种信道使用一对多的广播通信方式，因此过程比较复杂。广播信道上连接的主机很多，因此必须使用专用的共享信道协议来协调这些主机的数据发送。 
不同的链路层可能采用不同的数据链路层协议

![image-20200603203603889](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200603203603889.png)

## 3.1  使用点对点信道的数据链路层

**3.1.1  数据链路和帧**
**链路 (link)** 是一条无源的点到点的物理线路段，中间没有任何其他的交换结点，一条链路只是一条通路的一个组成部分。
**数据链路 (data link)** 除了物理线路外，还必须有通信协议来控制这些数据的传输。若把实现这些协议的硬件和软件加到链路上，就构成了数据链路。现在最常用的方法是使用适配器（即网卡）来实现这些协议的硬件和软件。一般的适配器都包括了数据链路层和物理层这两层的功能。
**数据链路层传送的是帧**
![image-20200603203831184](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200603203831184.png)
数据链路层不必考虑物理层如何实现比特传输的细节。甚至还可以更简单地设想好像是沿着两个数据链路层之间的水平方向把帧直接发送到对方。

3.1.2  三个基本问题
数据链路层协议有许多种，但有三个基本问题则是共同的。这三个基本问题是：
1.封装成帧、2.透明传输、3.差错控制 

1.封装成帧
**封装成帧 (framing)** 就是在一段数据的前后分别添加首部和尾部，然后就构成了一个帧。确定帧的界限。
首部和尾部的一个重要作用就是进行帧定界。  
![image-20200603204223226](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200603204223226.png)
当数据是由可打印的 ASCII 码组成的文本文件时，帧定界可以使用特殊的帧定界符。
控制字符 SOH (Start Of Header) 放在一帧的最前面，表示帧的首部开始。另一个控制字符 EOT (End Of Transmission) 表示帧的结束。
![image-20200603204253981](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200603204253981.png)

2.透明传输

如果数据中的某个字节的二进制代码恰好和 SOH 或 EOT 一样，数据链路层就会错误地“找到帧的边界”
![image-20200603204338746](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200603204338746.png)
解决方法：**字节填充** (byte stuffing) 或**字符填充** (character stuffing)。
发送端的数据链路层在数据中出现控制字符“SOH”或“EOT”的前面插入一个转义字符“ESC” (其十六进制编码是 1B)。
接收端的数据链路层在将数据送往网络层之前删除插入的转义字符。
如果转义字符也出现在数据当中，那么应在转义字符前面插入一个转义字符 ESC。当接收端收到连续的两个转义字符时，就删除其中前面的一个。 
![image-20200603204517309](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200603204517309.png)

3.差错检测
在传输过程中可能会产生比特差错：1 可能会变成 0 而 0 也可能变成 1。
在一段时间内，传输错误的比特占所传输比特总数的比率称为**误码率** BER (Bit Error Rate)。
误码率与信噪比有很大的关系。
为了保证数据传输的可靠性，在计算机网络传输数据时，必须采用各种差错检测措施。 

循环冗余检验的原理 ：
在数据链路层传送的帧中，广泛使用了**循环冗余**检验 CRC 的检错技术。
在发送端，先把数据划分为组。假定每组 k 个比特。 
假设待传送的一组数据 M = 101001（现在 k = 6）。我们在 M 的后面再添加供差错检测用的 n 位冗余码一起发送。  
循环冗余码CRC在发送端编码和接收端校验时，都可以利用**事先约定的生成多项式G(X)**来得到，
K位要发送的信息位可对应于一个(k-1)次多项式K(X),
r位冗余位则对应于一个(r-1)次多项式R(X)，
由r位冗余位组成的n=k+r位码字则对应于一个(n-1)次多项式`T(X)=X r *K(X)+R(X)`。

循环冗余码CRC具体实现过程:
（1）CRC码在发送端和接收端校验时，事先规定一个生成多项式：G(X)(r次多项式即r+1位)；
（2） k位信息位对应多项式K(X)；
（3）r位冗余位对应一个（r-1）次多项式R(X)；
（4）用X r *K(X)除以生成多项式G(X)，得到的余数就是冗余码
（5) 最后要发送的帧：T(X)= X r *K(X)+R(X)

冗余码的计算 :
用二进制的模 2 运算进行 2n 乘 M 的运算，这相当于在 M 后面添加 n 个 0。
得到的 (k + n) 位的数除以事先选定好的长度为 (n + 1) 位的除数 P，得出商是 Q 而余数是 R，余数 R 比除数 P 少 1 位，即 R 是 n 位。 
将余数 R 作为冗余码拼接在数据 M 后面发送出去。
例子：
k = 6, M = 101001。设 n = 3, 除数 P = 1101，被除数是 2nM = 101001000。 
模 2 运算的结果是：商 Q = 110101，余数 R = 001。
把余数 R 作为冗余码添加在数据 M 的后面发送出去。发送的数据是：2nM + R 
   即：101001001，共 (k + n) 位。 
![image-20200603211228067](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200603211228067.png)
**帧检验序列 FCS** 
在数据后面添加上的冗余码称为**帧检验序列 FCS** (Frame Check Sequence)。
循环冗余检验 CRC 和帧检验序列 FCS 并不等同。
CRC 是一种常用的检错方法，而 FCS 是添加在数据后面的冗余码。
FCS 可以用 CRC 这种方法得出，但 CRC 并非用来获得 FCS 的唯一方法。

接收端对收到的每一帧进行 CRC 检验 
(1) 若得出的余数 R = 0，则判定这个帧没有差错，就接受 (accept)。
(2) 若余数 R  0，则判定这个帧有差错，就丢弃。
但这种检测方法并不能确定究竟是哪一个或哪几个比特出现了差错。
只要经过严格的挑选，并使用位数足够多的除数 P，那么出现检测不到的差错的概率就很小很小。 

常见几种 CRC生成多项式国际标准

1.G(X)=X16+X15+X2+1(IBM公司设计CRC-16）
2.G(X)=X16+X12+X5+1(ITU设计CRC-CCITT）
3.G(X)=X12+X11+X3+X2+X十l
4.G(X)=X32+X26+X23+X22+X16+X12+X11+X10+X8+X7+X5+X4+X3+X+1 (IEEE以太网CRC-32）

## 3.2  点对点协议 PPP

**3.2.1  PPP 协议的特点**
对于点对点的链路，目前使用得最广泛的数据链路层协议是点对点协议 PPP (Point-to-Point Protocol)。
用户使用拨号电话线接入互联网时， 用户计算机和 ISP 进行通信时所使用的数据链路层协议就是 PPP 协议。
PPP 协议在1994年就已成为互联网的正式标准。
用户到 ISP 的链路使用 PPP 协议 .

 PPP 协议应满足的需求 
简单 —— 这是**首要的要求**。
封装成帧 —— 必须规定特殊的字符作为帧定界符。
透明性 —— 必须保证数据传输的透明性。
多种网络层协议 —— 能够在同一条物理链路上同时支持多种网络层协议。
多种类型链路 —— 能够在多种类型的链路上运行。
差错检测 —— 能够对接收端收到的帧进行检测，并立即丢弃有差错的帧。
检测连接状态 —— 能够及时自动检测出链路是否处于正常工作状态。
最大传送单元 —— 必须对每一种类型的点对点链路设置最大传送单元  MTU 的标准默认值，促进各种实现之间的互操作性。
网络层地址协商 —— 必须提供一种机制使通信的两个网络层实体能够通过协商知道或能够配置彼此的网络层地址。
数据压缩协商 —— 必须提供一种方法来协商使用数据压缩算法。

PPP 协议不需要的功能
纠错 、流量控制、序号、多点线路 、半双工或单工链路 

PPP 协议有三个组成部分：
(1) 一个将 IP 数据报封装到串行链路的方法。
(2) 链路控制协议 LCP (Link Control Protocol)。
(3) 网络控制协议 NCP (Network Control Protocol)。   

**3.2.2  PPP 协议的帧格式**
PPP 帧的首部和尾部分别为 4 个字段和 2 个字段。
标志字段 F = 0x7E （符号“0x”表示后面的字符是用十六进制表示。十六进制的 7E 的二进制表示是 01111110）。
地址字段 A 只置为 0xFF。地址字段实际上并不起作用。
控制字段 C 通常置为 0x03。
PPP 是面向字节的，所有的 PPP 帧的长度都是**整数字节**。
![image-20200603212157567](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200603212157567.png)
当 PPP 用在同步传输链路时，协议规定采用硬件来完成**比特填充**（和 HDLC 的做法一样）。 
当 PPP 用在异步传输时，就使用一种特殊的**字符填充**法。 
**字符填充 ：**
将信息字段中出现的每一个 0x7E 字节转变成为 2 字节序列 (0x7D, 0x5E)。 
若信息字段中出现一个 0x7D 的字节, 则将其转变成为 2 字节序列 (0x7D, 0x5D)。
若信息字段中出现 ASCII 码的控制字符（即数值小于 0x20 的字符），则在该字符前面要加入一个 0x7D 字节，同时将该字符的编码加以改变
**零比特填充** ：
PPP 协议用在 SONET/SDH 链路时，使用同步传输（一连串的比特连续传送）。这时 PPP 协议采用零比特填充方法来实现透明传输。
在发送端，只要发现有 5 个连续 1，则立即填入一个 0。
接收端对帧中的比特流进行扫描。每当发现 5 个连续1时，就把这 5 个连续 1 后的一个 0 删除。

PPP 协议之所以不使用序号和确认机制是出于以下的考虑：
在数据链路层出现差错的概率不大时，使用比较简单的 PPP 协议较为合理。
在因特网环境下，PPP 的信息字段放入的数据是 IP  数据报。数据链路层的可靠传输并不能够保证网络层的传输也是可靠的。
帧检验序列 FCS 字段可保证无差错接受。

**3.2.3  PPP 协议的工作状态**
当用户拨号接入 ISP 时，路由器的调制解调器对拨号做出确认，并建立一条物理连接。
PC 机向路由器发送一系列的 LCP 分组（封装成多个 PPP 帧）。
这些分组及其响应选择一些 PPP 参数，并进行网络层配置，NCP 给新接入的 PC 机分配一个临时的 IP 地址，使 PC 机成为因特网上的一个主机。
通信完毕时，NCP 释放网络层连接，收回原来分配出去的 IP 地址。接着，LCP 释放数据链路层连接。最后释放的是物理层的连接。
可见，PPP 协议已不是纯粹的数据链路层的协议，它**还包含了物理层和网络层的内容**。
![image-20200603212740123](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200603212740123.png)

## 3.3  使用广播信道的数据链路层

**3.3.1  局域网的数据链路层**
局域网最主要的特点是：
网络为一个单位所拥有；地理范围和站点数目均有限。 
局域网具有如下主要优点：
具有广播功能，从一个站点可很方便地访问全网。局域网上的主机可共享连接在局域网上的各种硬件和软件资源。 便于系统的扩展和逐渐地演变，各设备的位置可灵活调整和改变。提高了系统的可靠性、可用性和残存性。
局域网拓扑结构![局域网拓扑结构](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200603215958543.png)
以太网的两个标准 
**DIX Ethernet V2** 是世界上第一个局域网产品（以太网）的规约。
**IEEE 802.3** 是第一个 IEEE 的以太网标准。
DIX Ethernet V2 标准与 IEEE 的 802.3 标准只有很小的差别，因此可以将 802.3 局域网简称为“以太网”。
严格说来，“以太网”应当是指符合 DIX Ethernet V2 标准的局域网 

数据链路层的两个子层 
为了使数据链路层能更好地适应多种局域网标准，IEEE 802 委员会就将局域网的数据链路层拆成两个子层：
**逻辑链路控制 LLC** (Logical Link Control)子层；
**媒体接入控制 MAC** (Medium Access Control)子层。
与接入到传输媒体有关的内容都放在 MAC子层，而 LLC 子层则与传输媒体无关。
不管采用何种协议的局域网，对 LLC 子层来说都是透明的。

适配器的作用 
网络接口板又称为**通信适配器 (adapter)** 或**网络接口卡 NIC** (Network Interface Card)，或“**网卡**”。 
适配器的重要功能：
进行串行/并行转换。对数据进行缓存。在计算机的操作系统安装设备驱动程序。实现以太网协议。 
![计算机通过适配器和局域网进行通信 ](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200603220411410.png)
计算机通过适配器和局域网进行通信 

**3.3.2  CSMA/CD 协议**
最初的以太网是将许多计算机都连接到一根总线上。当初认为这样的连接方法既简单又可靠，因为总线上没有有源器件。 
![image-20200603220956430](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200603220956430.png)
以太网采用**广播**方式发送 
总线上的每一个工作的计算机都能检测到 B 发送的数据信号。 
由于只有计算机 D 的地址与数据帧首部写入的地址一致，因此只有 D 才接收这个数据帧。 
其他所有的计算机（A, C 和 E）都检测到不是发送给它们的数据帧，因此就丢弃这个数据帧而不能够收下来。
在具有广播特性的总线上实现了**一对一**的通信。  

**CSMA/CD协议** 
CSMA/CD 含义：**载波监听多点接入 / 碰撞检测**  (Carrier Sense Multiple Access with Collision Detection) 。
“**多点接入**”表示许多计算机以多点接入的方式连接在一根总线上。
“**载波监听**”是指每一个站在发送数据之前先要检测一下总线上是否有其他计算机在发送数据，如果有，则暂时不要发送数据，以免发生碰撞。 
总线上并没有什么“载波”。因此， “载波监听”就是用电子技术检测总线上有没有其他计算机发送的数据信号。
“**碰撞检测**”就是计算机边发送数据边检测信道上的信号电压大小。
当几个站同时在总线上发送数据时，总线上的信号电压摆动值将会增大（互相叠加）。
当一个站检测到的信号电压摆动值超过一定的门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞。
所谓“碰撞”就是发生了冲突。因此“碰撞检测”也称为“冲突检测”
在发生碰撞时，总线上传输的信号产生了严重的失真，无法从中恢复出有用的信息来。
每一个正在发送数据的站，一旦发现总线上出现了碰撞，就要立即停止发送，免得继续浪费网络资源，然后等待一段随机时间后再次发送

为什么要进行碰撞检测？
由于电磁波在总线上的传播速率是有限的，当某个站监听到总线是空闲时，也可能总线并非真正是空闲的。 
A 向 B 发出的信息，要经过一定的时间后才能传送到 B。
B 若在 A 发送的信息到达 B 之前发送自己的帧 (因为这时 B 的载波监听检测不到 A 所发送的信息)，则必然要在某个时间和 A 发送的帧发生碰撞。
碰撞的结果是两个帧都变得无用。
所以需要在发送期间进行碰撞检测，以检测冲突。
![image-20200604014236272](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200604014236272.png)
**CSMA/CD 重要特性**
使用 CSMA/CD 协议的以太网不能进行全双工通信而**只能进行双向交替通信**（半双工通信）。
每个站在发送数据之后的一小段时间内，存在着遭遇碰撞的可能性。 
这种**发送的不确定性**使整个以太网的平均通信量远小于以太网的最高数据率。  
最先发送数据帧的站，在发送数据帧后至多经过时间 2t （两倍的端到端往返时延）就可知道发送的数据帧是否遭受了碰撞。
以太网的端到端往返时延 2t 称为争用期，或**碰撞窗口**。
经过争用期这段时间还没有检测到碰撞，才能肯定这次发送不会发生碰撞。

二进制指数类型退避算法 (truncated binary exponential type)
发生碰撞的站在停止发送数据后，要推迟（退避）一个随机时间才能再发送数据。
基本退避时间取为争用期 2t。
从整数集合 [0, 1, … , (2^k -1)] 中随机地取出一个数，记为 r。重传所需的时延就是 r 倍的基本退避时间。
参数 k 按下面的公式计算：
` k = Min[重传次数, 10]`
当 k<=10 时，参数 k 等于重传次数。
当重传达 16 次仍不能成功时即丢弃该帧，并向高层报告。 

**强化碰撞** 
当发送数据的站一旦发现发生了碰撞时：
(1) 立即停止发送数据；
(2) 再继续发送若干比特的人为干扰信号  (jamming signal)，以便让所有用户都知道现在已经发生了碰撞。  
![image-20200604015247393](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200604015247393.png)
CSMA/CD协议的要点
(1) 准备发送。但在发送之前，必须先检测信道。
(2) 检测信道。若检测到信道忙，则应不停地检测，一直等待信道转为空闲。若检测到信道空闲，并在 96 比特时间内信道保持空闲（保证了帧间最小间隔），就发送这个帧。
(3) 检查碰撞。在发送过程中仍不停地检测信道，即网络适配器要边发送边监听。这里只有两种可能性：
①发送成功：在争用期内一直未检测到碰撞。这个帧肯定能够发送成功。发送完毕后，其他什么也不做。然后回到 (1)。
②发送失败：在争用期内检测到碰撞。这时立即停止发送数据，并按规定发送人为干扰信号。适配器接着就执行指数退避算法，等待 r 倍 512 比特时间后，返回到步骤 (2)，继续检测信道。但若重传达 16 次仍不能成功，则停止重传而向上报错。

**3.3.3  使用集线器的星形拓扑**
传统以太网最初是使用粗同轴电缆，后来演进到使用比较便宜的细同轴电缆，最后发展为使用更便宜和更灵活的双绞线。
采用双绞线的以太网采用星形拓扑，在星形的中心则增加了一种可靠性非常高的设备，叫做**集线器 (hub)**。
![image-20200604015343963](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200604015343963.png)
1990 年，IEEE 制定出星形以太网 10BASE-T 的标准 802.3i。
![image-20200604015407623](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200604015407623.png)
星形以太网 10BASE-T 
使用无屏蔽双绞线，采用星形拓扑。
每个站需要用两对双绞线，分别用于发送和接收。
双绞线的两端使用 RJ-45 插头。
集线器使用了大规模集成电路芯片，因此集线器的可靠性提高。 
10BASE-T 的通信距离稍短，每个站到集线器的距离不超过 100 m。
这种 10 Mbit/s 速率的无屏蔽双绞线星形网的出现，既降低了成本，又提高了可靠性。 具有很高的性价比。
10BASE-T 双绞线以太网的出现，是局域网发展史上的一个非常重要的里程碑，它为以太网在局域网中的统治地位奠定了牢固的基础。
从此以太网的拓扑就从总线形变为更加方便的星形网络，而以太网也就在局域网中占据了统治地位。 

集线器的一些特点 
(1) 集线器是使用电子器件来模拟实际电缆线的工作，因此整个系统仍然像一个传统的以太网那样运行。 
(2) 使用集线器的以太网在**逻辑上仍是一个总线网**，各工作站使用的还是 CSMA/CD 协议，并共享逻辑上的总线。 
(3) 集线器很像一个多接口的转发器，**工作在物理层**。
(4) 集线器采用了专门的芯片，进行自适应串音回波抵消，减少了近端串音。![image-20200604015645270](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200604015645270.png)具有三个接口的集线器 

**3.3.4  以太网的信道利用率**
多个站在以太网上同时工作就可能会发生碰撞。
当发生碰撞时，信道资源实际上是被浪费了。因此，当扣除碰撞所造成的信道损失后，以太网总的信道利用率并不能达到 100%。
假设 t 是以太网单程端到端传播时延。则争用期长度为 2t，即端到端传播时延的两倍。检测到碰撞后不发送干扰信号。
设帧长为 L (bit)，数据发送速率为 C (bit/s)，则帧的发送时间为  `T0 = L/C (s)`。 
要提高以太网的信道利用率，就必须减小 t 与 T0 之比。
在以太网中定义了参数 α，它是以太网单程端到端时延 t 与帧的发送时间 T0 之比： `α=t/T0`
α →0，表示一发生碰撞就立即可以检测出来， 并立即停止发送，因而信道利用率很高。
α 越大，表明争用期所占的比例增大，每发生一次碰撞就浪费许多信道资源，使得信道利用率明显降低
对以太网参数 α 的**要求**是：
当数据率一定时，以太网的连线的长度受到限制，否则 t的数值会太大。
以太网的帧长不能太短，否则 T0 的值会太小，使 α 值太大。 

**3.3.5  以太网的 MAC 层**
重点介绍：MAC 层的硬件地址、MAC 帧的格式

1.MAC 层的硬件地址 
在局域网中，**硬件地址**又称为**物理地址**，或 **MAC 地址**。 
802 标准所说的“地址”严格地讲应当是每一个站的“名字”或**标识符**。 
但鉴于大家都早已习惯了将这种 48 位的“名字”称为“地址”，所以本书也采用这种习惯用法，尽管这种说法并不太严格。
请注意，如果连接在局域网上的主机或路由器安装有多个适配器，那么这样的主机或路由器就有多个“地址”。更准确些说，这种 48 位“地址”应当是某个接口的标识符。
IEEE 802 标准规定 MAC 地址字段可采用 6 字节 ( 48位) 或 2 字节 ( 16 位) 这两种中的一种。
IEEE 的注册管理机构 RA 负责向厂家分配地址字段 6 个字节中的前三个字节 (即高位 24 位)，称为**组织唯一标识符**。
地址字段 6 个字节中的后三个字节 (即低位 24 位) 由厂家自行指派，称为**扩展唯一标识符**，必须保证生产出的适配器**没有重复地址**。
![image-20200604020335387](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200604020335387.png)
一个地址块可以生成 2^24 个不同的地址。这种 48 位地址称为 MAC-48，它的通用名称是 EUI-48。
生产适配器时，6 字节的 MAC 地址已被固化在适配器的 ROM，因此，MAC 地址也叫做**硬件地址** (hardware address)或**物理地址**。
“MAC地址”实际上就是适配器地址或适配器标识符 EUI-48。

单站地址，组地址，广播地址
IEEE 规定地址字段的**第一字节的最低位**为 I/G 位。I/G 表示 Individual / Group。
当 **I/G位 = 0** 时，地址字段表示一个**单站地址**。
当 **I/G位 = 1** 时，表示**组地址**，用来进行多播（以前曾译为组播）。此时，IEEE 只分配地址字段前三个字节中的 23 位。
当 I/G 位分别为 0 和 1 时，一个地址块可分别生成 223 个单个站地址和 223 个组地址。
所有 48 位都为 1 时，为广播地址。只能作为目的地址使用。

全球管理与本地管理
IEEE 把地址字段第一字节的**最低第 2 位**规定为 G/L 位，表示 Global / Local。
当 G/L位 = 0 时，是**全球管理**（保证在全球没有相同的地址），厂商向IEEE购买的 OUI 都属于全球管理。
当 G/L位 = 1 时， 是**本地管理**，这时用户可任意分配网络上的地址。

适配器从网络上每收到一个 MAC 帧就首先用硬件检查 MAC 帧中的 MAC 地址。
如果是发往本站的帧则收下，然后再进行其他的处理。
否则就将此帧丢弃，不再进行其他的处理。
“发往本站的帧”包括以下三种帧： 
**单播** (unicast) 帧（一对一）
**广播** (broadcast) 帧（一对全体）
**多播** (multicast) 帧（一对多）
所有的适配器都至少能**够识别**前两种帧，即能够识别单播地址和广播地址。
有的适配器可用编程方法识别多播地址。
**只有目的地址才能**使用广播地址和多播地址。
以**混杂方式** (promiscuous mode) 工作的以太网适配器只要“听到”有帧在以太网上传输就都接收下来。

2**.MAC 帧的格式**
常用的以太网 MAC 帧格式有两种标准 ：
DIX Ethernet V2 标准
IEEE 的 802.3 标准
最常用的 MAC 帧是**以太网 V2** 的格式。
![image-20200604020758567](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200604020758567.png)
以太网V2的 MAC 帧格式
目的地址字段 6 字节
源地址字段 6 字节
类型字段 2 字节,类型字段用来标志上一层使用的是什么协议，以便把收到的 MAC 帧的数据上交给上一层的这个协议。 
数据字段 46 ~ 1500 字节,数据字段的正式名称是 **MAC 客户数据字段**。最小长度 64 字节  18 字节的首部和尾部  =  数据字段的最小长度（46字节）
FCS 字段 4 字节,当数据字段的长度小于 46 字节时，应在数据字段的后面加入整数字节的填充字段，以保证以太网的 MAC 帧长不小于 64 字节。 
在帧的前面插入（硬件生成）的 8 字节中，第一个字段共 7 个字节，是前同步码，用来迅速实现 MAC 帧的比特同步。第二个字段 1 个字节是帧开始定界符，表示后面的信息就是 MAC 帧。 
无效的 MAC 帧 ,帧的长度不是整数个字节；用收到的帧检验序列 FCS 查出有差错；数据字段的长度不在 46 ~ 1500 字节之间。有效的 MAC 帧长度为 64 ~ 1518 字节之间。

与以太网V2 MAC 帧格式相似，区别在于：
(1) IEEE 802.3 规定的 MAC 帧的第三个字段是“**长度 / 类型**”。
当这个字段值大于 0x0600 时（相当于十进制的 1536），就表示“类型”。这样的帧和以太网 V2 MAC 帧完全一样。
当这个字段值小于 0x0600 时才表示“长度”。
(2) 当“长度/类型”字段值小于 0x0600 时，数据字段必须装入上面的逻辑链路控制 LLC 子层的 LLC 帧

## 3.4  扩展的以太网

**3.4.1  在物理层扩展以太网**
使用光纤扩展
主机使用光纤（通常是一对光纤）和一对光纤调制解调器连接到集线器。 
很容易使主机和几公里以外的集线器相连接。
![image-20200604021216700](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200604021216700.png)

使用集线器扩展
使用多个集线器可连成更大的、多级星形结构的以太网。
例如，一个学院的三个系各有一个 10BASE-T 以太网，可通过一个主干集线器把各系的以太网连接起来，成为一个更大的以太网。
![image-20200604021243139](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200604021243139.png)
优点：
使原来属于不同碰撞域的以太网上的计算机能够进行跨碰撞域的通信。
扩大了以太网覆盖的地理范围。
缺点：
碰撞域增大了，但总的吞吐量并未提高。
如果不同的碰撞域使用不同的数据率，那么就不能用集线器将它们互连起来。   

**3.4.2  在数据链路层扩展以太网**
扩展以太网更常用的方法是在数据链路层进行。
早期使用**网桥**，现在使用以太网**交换机**。
**网桥**工作在数据链路层。
它根据 MAC 帧的目的地址对收到的帧进行**转发和过滤**。
当网桥收到一个帧时，并不是向所有的接口转发此帧，而是先检查此帧的目的 MAC 地址，然后再确定将该帧转发到哪一个接口，或把它丢弃。 
1990 年问世的交换式集线器 (switching hub) 可明显地提高以太网的性能。
**交换式集线器**常称为**以太网交换机** (switch) 或**第二层交换机** (L2 switch)，强调这种交换机工作在数据链路层。

以太网交换机的**特点**
以太网交换机实质上就是一个**多接口的网桥**。通常都有十几个或更多的接口。
每个接口都直接与一个单台主机或另一个以太网交换机相连，并且一般都工作在**全双工方式**。
以太网交换机**具有并行性**，能同时连通多对接口，使多对主机能同时通信。
相互通信的主机都是独占传输媒体，无碰撞地传输数据。
以太网交换机的接口有存储器，能在输出端口繁忙时把到来的帧进行缓存。
以太网交换机是一种**即插即用**设备，其内部的帧交换表（又称为地址表）是通过自学习算法自动地逐渐建立起来的。
以太网交换机使用了专用的交换结构芯片，用硬件转发，其转发速率要比使用软件转发的网桥快很多。

以太网交换机的**优点**
用户独享带宽，增加了总容量。
对于普通 10 Mbit/s 的共享式以太网，若共有 N 个用户，则每个用户占有的平均带宽只有总带宽 (10 Mbit/s)的 N 分之一。
使用以太网交换机时，虽然在每个接口到主机的带宽还是 10 Mbit/s，但由于一个用户在通信时是独占而不是和其他网络用户共享传输媒体的带宽，因此对于拥有 N 个接口的交换机的总容量为 N10 Mbit/s。
从共享总线以太网转到交换式以太网时，所有接入设备的软件和硬件、适配器等都不需要做任何改动。
以太网交换机一般都具有多种速率的接口，方便了各种不同情况的用户。

以太网交换机的**交换方式**
**存储转发方式**：把整个数据帧先缓存后再进行处理。
**直通 (cut-through) 方式**：
接收数据帧的同时就立即按数据帧的目的 MAC 地址决定该帧的转发接口，因而提高了帧的转发速度。
**缺点**是它不检查差错就直接将帧转发出去，因此有可能也将一些无效帧转发给其他的站。
在某些情况下，仍需要采用基于软件的存储转发方式进行交换，例如，当需要进行线路速率匹配、协议转换或差错检测时。

以太网交换机的**自学习功能**
以太网交换机运行自学习算法自动维护**交换表**。
开始时，以太网交换机里面的交换表是空的。

*按照以下自学习算法，处理收到的帧和建立交换表*
A 先向 B 发送一帧，从接口 1 进入到交换机。
交换机收到帧后，先查找交换表，没有查到应从哪个接口转发这个帧。
交换机把这个帧的源地址 A 和接口 1 写入交换表中，并向除接口1以外的所有的接口广播这个帧。
C 和 D 将丢弃这个帧，因为目的地址不对。只 B 才收下这个目的地址正确的帧。这也称为过滤。
从新写入交换表的项目 (A, 1) 可以看出，以后不管从哪一个接口收到帧，只要其目的地址是A，就应当把收到的帧从接口1转发出去。
B 通过接口 3 向 A 发送一帧。
交换机查找交换表，发现交换表中的 MAC 地址有 A。表明要发送给A的帧（即目的地址为 A 的帧）应从接口1转发。于是就把这个帧传送到接口 1 转发给 A。显然，现在已经没有必要再广播收到的帧。
交换表这时新增加的项目 (B, 3)，表明今后如有发送给 B 的帧，就应当从接口 3 转发出去。
经过一段时间后，只要主机 C 和 D 也向其他主机发送帧，以太网交换机中的交换表就会把转发到 C 或 D 应当经过的接口号（2 或 4）写入到交换表中。
![image-20200605113321840](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200605113321840.png)
考虑到可能有时要在交换机的接口更换主机，或者主机要更换其网络适配器，这就需要更改交换表中的项目。为此，在交换表中每个项目都设有一定的有效时间。过期的项目就自动被删除。

交换机自学习和转发帧的步骤归纳 
交换机收到一帧后先进行自学习。查找交换表中与收到帧的源地址有无相匹配的项目。
如没有，就在交换表中增加一个项目（源地址、进入的接口和有效时间）。
如有，则把原有的项目进行更新（进入的接口或有效时间）。
转发帧。查找交换表中与收到帧的目的地址有无相匹配的项目。
如没有，则向所有其他接口（进入的接口除外）转发。
如有，则按交换表中给出的接口进行转发。
若交换表中给出的接口就是该帧进入交换机的接口，则应丢弃这个帧（因为这时不需要经过交换机进行转发）。

增加冗余链路时，自学习的过程就可能导致以太网帧在网络的某个环路中无限制地兜圈子。
按交换机自学习和转发方法，该帧的某个走向如下：离开交换机 #1 的接口 3 → 交换机 #2 的接口 1 → 接口 2 → 交换机 #1 的接口 4 → 接口 3 → 交换机 #2 的接口 1 →……。这样就无限制地循环兜圈子下去，白白消耗了网络资源。
所以IEEE 802.1D 标准制定了一个**生成树协议 STP**  (Spanning Tree Protocol)。
其要点是：不改变网络的实际拓扑，但在逻辑上则切断某些链路，使得从一台主机到所有其他主机的路径是无环路的树状结构，从而消除了兜圈子现象。

从总线以太网到星形以太网
早期，以太网采用无源的总线结构。
现在，采用以太网交换机的星形结构成为以太网的首选拓扑。
总线以太网使用 CSMA/CD 协议，以半双工方式工作。
以太网交换机不使用共享总线，没有碰撞问题，因此不使用 CSMA/CD 协议，而是以全双工方式工作。但**仍然采用以太网的帧结构**。

**3.4.3  虚拟局域网**
利用以太网交换机可以很方便地实现虚拟局域网 VLAN (Virtual LAN)。
**虚拟局域网 VLAN** 是由一些局域网网段构成的与物理位置无关的逻辑组，而这些网段具有某些共同的需求。每一个 VLAN 的帧都有一个明确的标识符，指明发送这个帧的计算机是属于哪一个 VLAN。
虚拟局域网其实只是局域网给用户提供的一种服务，而并不是一种新型局域网。
由于虚拟局域网是用户和网络资源的逻辑组合，因此可按照需要将有关设备和资源非常方便地重新组合，使用户从不同的服务器或数据库中存取所需的资源。
虚拟局域网限制了接收广播信息的工作站数，使得网络不会因传播过多的广播信息(即“**广播风暴**”)而引起性能恶化。 

虚拟局域网使用的**以太网帧格式**
IEEE 批准了 802.3ac 标准，该标准定义了以太网的帧格式的扩展，以支持虚拟局域网。
虚拟局域网协议允许在以太网的帧格式中插入一个4字节的标识符，称为 **VLAN 标记 (tag)**，用来指明发送该帧的计算机属于哪一个虚拟局域网。
插入 VLAN 标记得出的帧称为 **802.1Q 帧** 或 **带标记的以太网帧**。
![image-20200605114055211](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200605114055211.png)

## 3.5  高速以太网

**3.5.1  100BASE-T 以太网**
速率达到或超过 100 Mbit/s 的以太网称为**高速以太网**。
100BASE-T 在双绞线上传送 100 Mbit/s 基带信号的星形拓扑以太网，仍使用 IEEE 802.3 的CSMA/CD 协议。
100BASE-T 以太网又称为**快速以太网** (Fast Ethernet)。
1995 年IEEE已把 100BASE-T 的快速以太网定为正式标准，其代号为 **IEEE 802.3u**。

100BASE-T 以太网的**特点**
可在全双工方式下工作而无冲突发生。在全双工方式下工作时，不使用 CSMA/CD 协议。
MAC 帧格式仍然是 802.3 标准规定的。
保持最短帧长不变，但将一个网段的**最大电缆长度减小**到 100 m。
帧间时间间隔从原来的 9.6 us 改为现在的 0.96 us。    

100 Mbit/s 以太网的三种不同的物理层标准 
100BASE-TX
使用 2 对 UTP 5 类线 或 屏蔽双绞线 STP。
网段最大程度：100米。
100BASE-T4
使用 4 对 UTP 3 类线 或 5 类线。 
网段最大程度：100米。
100BASE-FX 
使用 2 对光纤。 
网段最大程度：2000米。

**3.5.2  吉比特以太网**
允许在 1 Gbit/s 下以全双工和半双工两种方式工作。
使用 IEEE 802.3 协议规定的帧格式。
在半双工方式下使用 CSMA/CD 协议，全双工方式不使用 CSMA/CD 协议。
与 10BASE-T 和 100BASE-T 技术向后兼容。

吉比特以太网的物理层使用两种成熟的技术：一种来自现有的以太网，另一种则是美国国家标准协会 ANSI 制定的光纤通道 FC  (Fiber Channel)。

**半双工**方式工作的吉比特以太网
吉比特以太网工作在半双工方式时，就必须进行碰撞检测。
为保持 64 字节最小帧长度，以及 100 米的网段的最大长度，吉比特以太网增加了两个功能：
**载波延伸 (carrier extension)**
**分组突发 (packet bursting)**

载波延伸
使最短帧长仍为 64 字节（这样可以保持兼容性），同时将**争用时间增大**为 512 字节。
凡发送的 MAC 帧长不足 512 字节时，就用一些特殊字符填充在帧的后面，使MAC 帧的发送长度增大到 512 字节。接收端在收到以太网的 MAC 帧后，要将所填充的特殊字符删除后才向高层交付。
分组突发
当很多短帧要发送时，第一个短帧要采用载波延伸方法进行填充，随后的一些短帧则可一个接一个地发送，只需留有必要的帧间最小间隔即可。这样就形成可一串分组的突发，直到达到 1500 字节或稍多一些为止。

当吉比特以太网工作在全双工方式时（即通信双方可同时进行发送和接收数据），不使用载波延伸和分组突发。
![image-20200605115110122](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200605115110122.png)

**3.5.3  10吉比特以太网 (10GE) 和更快的以太网**
10 吉比特以太网（10GE）并非把吉比特以太网的速率简单地提高到 10 倍，其主要特点有：
与 10 Mbit/s、100 Mbit/s 和 1 Gbit/s 以太网的**帧格式完全相同**。
保留了 802.3 标准规定的以太网最小和最大帧长，便于升级。
不再使用铜线而**只使用光纤**作为传输媒体。
**只工作在全双工**方式，因此没有争用问题，也不使用 CSMA/CD 协议。    

**更快的以太网**
以太网的技术发展得很快。
在 10GE 之后又制订了 40GE/100GE（即 40 吉比特以太网和 100 吉比特以太网）的标准 IEEE 802.3ba-2010 和 802.3bm-2015。
40GE/100GE 只工作在全双工的传输方式（因而不使用 CSMA/CD 协议），并仍保持了以太网的帧格式以及 802.3 标准规定的以太网最小和最大帧长。
100GE 在使用单模光纤传输时，仍然可以达到 40 km 的传输距离，但这是需要波分复用（使用 4 个波长复用一根光纤，每一个波长的有效传输速率是 25 Gbit/s）。

端到端的以太网传输 
以太网的工作范围已经从局域网（校园网、企业网）扩大到城域网和广域网，从而实现了端到端的以太网传输。
这种工作方式的**好处**有： 
技术成熟；
互操作性很好；
在广域网中使用以太网时价格便宜；
采用统一的以太网帧格式，简化了操作和管理。     

以太网从 10 Mbit/s 到 100 Gbit/s 的演进证明了以太网是：
可扩展的（从 10 Mbit/s 到 100 Gbit/s）；
灵活的（多种传输媒体、全/半双工、共享/交换）；
易于安装；
稳健性好。 

**3.5.4  使用以太网进行宽带接入**
IEEE 在 2001 年初成立了 802.3 EFM 工作组，专门研究高速以太网的宽带接入技术问题。
以太网宽带接入具有以下**特点**：
可以提供**双向**的宽带通信。
可以根据用户对带宽的需求灵活地进行带宽**升级**。
可以实现端到端的以太网传输，中间**不需要再进行帧格式的转换**。这就提高了数据的传输效率且降低了传输的成本。
但是**不支持用户身份鉴别**。

PPPoE
**PPPoE (PPP over Ethernet)** 的意思是“在以太网上运行 PPP”，它把 PPP 协议与以太网协议结合起来 —— 将 PPP 帧再封装到以太网中来传输。
现在的光纤宽带接入 FTTx 都要使用 PPPoE 的方式进行接入。在 PPPoE 弹出的窗口中键入在网络运营商购买的用户名和密码，就可以进行宽带上网了。
利用 ADSL 进行宽带上网时，从用户个人电脑到家中的 ADSL 调制解调器之间，也是使用 RJ-45 和 5 类线（即以太网使用的网线）进行连接的，并且也是使用 PPPoE 弹出的窗口进行拨号连接的。

# 4.网络层

本章重点内容
网际协议 IP（即IPv4)
划分子网和构造超网
互联网的路由选择协议
IPv6
虚拟专用网 VPN 和网络地址转换 NAT

## 4.1 网络层提供的两种服务

在计算机网络领域，网络层应该向运输层提供怎样的服务（“**面向连接**”还是“**无连接**”）
在计算机通信中，可靠交付应当由谁来负责？是网络还是端系统？

一种观点：让网络负责可靠交付
这种观点认为，应借助于电信网的成功经验，让网络负责可靠交付，计算机网络应模仿电信网络，使用**面向连接**的通信方式。
通信之前先建立**虚电路(Virtual Circuit)**，以保证双方通信所需的一切网络资源。
如果再使用可靠传输的网络协议，就可使所发送的分组无差错按序到达终点，不丢失、不重复。
![image-20200605165522948](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200605165522948.png)
虚电路表示这只是一条**逻辑上的**连接，分组都沿着这条逻辑连接按照存储转发方式传送，而并不是真正建立了一条物理连接。
请注意，电路交换的电话通信是先建立了一条真正的连接。
因此分组交换的虚连接和电路交换的连接只是类似，但并不完全一样。

另一种观点：网络提供数据报服务
互联网的先驱者提出了一种崭新的网络设计思路。
网络层向上只提供简单灵活的、无连接的、尽最大努力交付的**数据报服务**。
网络在发送分组时不需要先建立连接。每一个分组（即 IP 数据报）独立发送，与其前后的分组无关（不进行编号）。
**网络层不提供服务质量**的承诺。即所传送的分组可能出错、丢失、重复和失序（不按序到达终点），当然也不保证分组传送的时限。
由于传输网络不提供端到端的可靠传输服务，这就使网络中的路由器可以做得比较简单，而且价格低廉（与电信网的交换机相比较）。
如果主机（即端系统）中的进程之间的通信需要是可靠的，那么就由网络的主机中的运输层负责可靠交付（包括差错处理、流量控制等）。
采用这种设计思路的**好处**是：网络的造价大大降低，运行方式灵活，能够适应多种应用。
互连网能够发展到今日的规模，充分证明了当初采用这种设计思路的正确性。
![image-20200605165656334](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200605165656334.png)
![image-20200605165741334](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200605165741334.png)

## 4.2 网际协议 IP

网际协议 IP 是 TCP/IP 体系中两个最主要的协议之一。
与 IP 协议配套使用的还有三个协议：
**地址解析协议 ARP (Address Resolution Protocol)**
**网际控制报文协议 ICMP (Internet Control Message Protocol)**
**网际组管理协议 IGMP (Internet Group Management Protocol)**
![image-20200605165844957](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200605165844957.png)

**4.2.1 虚拟互连网络**
将网络互连并能够互相通信，会遇到许多问题需要解决。
将网络互相连接起来要使用一些中间设备。中间设备又称为**中间系统**或**中继(relay)系统**。
有以下五种不同的中间设备：
物理层中继系统：**转发器(repeater)。**
数据链路层中继系统：**网桥或桥接器(bridge)**。
网络层中继系统：**路由器(router)**。
网桥和路由器的混合物：**桥路器(brouter)**。
网络层以上的中继系统：**网关(gateway)**。

当中继系统是转发器或网桥时，一般并不称之为网络互连，因为这仅仅是把一个网络扩大了，而这仍然是一个网络。
网关由于比较复杂，目前使用得较少。
**网络互连**都是指用路由器进行网络互连和路由选择。
由于历史的原因，许多有关 TCP/IP 的文献将网络层使用的路由器称为**网关**。![image-20200605170148441](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200605170148441.png)
虚拟互连网络的**意义**
所谓虚拟互连网络也就是**逻辑互连网络**，它的意思就是互连起来的各种物理网络的异构性本来是客观存在的，但是我们利用 IP 协议就可以使这些性能各异的网络从用户看起来好像是**一个统一的网络**。
使用 IP 协议的虚拟互连网络可简称为**IP 网**。
使用虚拟互连网络的**好处**是：当互联网上的主机进行通信时，就好像在一个网络上通信一样，而看不见互连的各具体的网络异构细节。
如果在这种覆盖全球的 IP 网的上层使用 TCP 协议，那么就是现在的**互联网(Internet)**。
![image-20200605170323300](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200605170323300.png)
如果我们只从网络层考虑问题，那么 IP 数据报就可以想象是在网络层中传送
![image-20200605170346129](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200605170346129.png)

**4.2.2 分类的 IP 地址**
在 TCP/IP 体系中，IP 地址是一个最基本的概念。

**1. IP 地址及其表示方法**
我们把整个因特网看成为一个单一的、抽象的网络。
IP 地址就是给每个连接在互联网上的主机（或路由器）分配一个在全世界范围是**唯一的32 位的标识符**。
IP 地址现在由**互联网名字和数字分配机构ICANN**(Internet Corporation for Assigned Names and Numbers)进行分配。
IP 地址的编址方法
**分类的 IP 地址**。这是**最基本的编址方法**，在1981 年就通过了相应的标准协议。
**子网的划分**。这是对最基本的编址方法的**改进**，其标准[RFC 950]在1985 年通过。
**构成超网。**这是比较新的**无分类编址**方法。1993 年提出后很快就得到推广应用。

分类 IP 地址
将IP地址划分为若干个固定类。
每一类地址都由两个固定长度的字段组成，其中一个字段是**网络号 net-id**，它标志主机（或路由器）所连接到的网络，而另一个字段则是**主机号 host-id**，它标志该主机（或路由器）。
主机号在它前面的网络号所指明的网络范围内必须是唯一的。
由此可见，一个 IP 地址在整个互联网范围内是唯一的。
![image-20200605170745601](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200605170745601.png)
![image-20200605170757057](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200605170757057.png)
![image-20200605170818813](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200605170818813.png)
A 类地址的网络号字段 net-id 为 1 字节，A 类地址的主机号字段 host-id 为 3 字节。
B 类地址的网络号字段 net-id 为 2 字节，B 类地址的主机号字段 host-id 为 2 字节。
C 类地址的网络号字段 net-id 为 3 字节，C 类地址的主机号字段 host-id 为 1 字节。
D 类地址是多播地址，E 类地址保留为今后使用。

**2.常用的三种类别的 IP 地址**
IP 地址的指派范围
![image-20200605171040115](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200605171040115.png)
**一般不使用的特殊的 IP 地址**

| 特殊地址               | 网络号 | 主机号 | 源地址或目的地址 | 说明                                                         |
| ---------------------- | ------ | ------ | ---------------- | ------------------------------------------------------------ |
| 网络地址               | 特定   | 全0    | 都不是           | 表示某个网段如：123.123.123.0                                |
| 直接广播地址           | 特定   | 全1    | 目的地址         | 作为广播地址，分组传给该网络所有节点123.123.123.255          |
| 受限广播地址           | 全1    | 全1    | 目的地址         | 分组发给本网络中的所有主机255.255.255.255                    |
| 本网络上的特定主机地址 | 全0    | 特定   | 目的地址         | 本网内部的特定主机地址0.0.0.123                              |
| 本网络本主机           | 全0    | 全0    | 源地址           | 表示本机地址，仅在系统启动时使用，0.0.0.0                    |
| 送回地址               | 127    | 任意   | 目的地址         | 用于网络软件测试与本地进程之间的通信。无论发送说明都会送回127.0.0.1 localhost |

专用IP地址（私网地址）：仅用于组建的专用内部网（局域网），其他地址属于公网地址（Internet地址），一般不用于局域网地址。

| 起始地址    | 终止地址        | 说明               |
| ----------- | --------------- | ------------------ |
| 10.0.0.0    | 10.255.255.255  | 1个连续的A类地址   |
| 172.16.0.0  | 172.31.255.255  | 16个连续的B类地址  |
| 192.168.0.0 | 192.168.255.255 | 256个连续的C类地址 |

**IP 地址的一些重要特点：**
(1)**IP 地址是一种分等级的地址结构**。分两个等级的好处是：
第一，IP 地址管理机构在分配 IP 地址时只分配网络号，而剩下的主机号则由得到该网络号的单位自行分配。这样就方便了 IP 地址的管理
第二，路由器仅根据目的主机所连接的网络号来转发分组（而不考虑目的主机号），这样就可以使路由表中的项目数大幅度减少，从而减小了路由表所占的存储空间。
(2)实际上 IP 地址是标志一个主机（或路由器）和一条链路的**接口**。
当一个主机同时连接到两个网络上时，该主机就必须同时具有两个相应的 IP 地址，其网络号 net-id 必须是不同的。这种主机称为多归**属主机(multihomed host)。**
由于一个路由器至少应当连接到两个网络（这样它才能将 IP 数据报从一个网络转发到另一个网络），因此一个路由器至少应当有两个不同的 IP 地址。
(3)用转发器或网桥连接起来的若干个局域网仍为一个网络，因此这些局域网都具有同样的网络号 net-id。
(4)所有分配到网络号 net-id 的网络，无论是范围很小的局域网，还是可能覆盖很大地理范围的广域网，都是平等的。

**4.2.3  IP 地址与硬件地址**
IP 地址与硬件地址是不同的地址。
从层次的角度看，
**硬件地址**（或物理地址）是数据链路层和物理层使用的地址。
**IP 地址**是网络层和以上各层使用的地址，是一种逻辑地址（称 IP 地址是逻辑地址是因为 IP 地址是用软件实现的）
![image-20200609185749398](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200609185749398.png)
![image-20200609185942877](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200609185942877.png)
在 IP 层抽象的互联网上只能看到 IP 数据报。图中的 IP1 → IP2 表示从源地址 IP1 到目的地址 IP2 。
路由器只根据目的站的 IP 地址的网络号进行路由选择。
在具体的物理网络的链路层
只能看见 MAC 帧而看不见 IP 数据报
IP 层抽象的互联网屏蔽了下层很复杂的细节。在抽象的网络层上讨论问题，就能够使用统一的、抽象的 IP 地址研究主机和主机或主机和路由器之间的通信。
![image-20200609190113602](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200609190113602.png)**4.2.4 地址解析协议 ARP**
通信时使用了两个地址：IP 地址（网络层地址）MAC 地址（数据链路层地址）
每个接口都有这两个地址

地址解析协议 ARP 的作用
已经知道了一个机器（主机或路由器）的IP地址，如何找出其相应的硬件地址？
地址解析协议 ARP 就是用来解决这样的问题的。
**ARP 作用**：从网络层使用的 IP 地址，解析出在数据链路层使用的硬件地址。

不管网络层使用的是什么协议，在实际网络的链路上传送数据帧时，最终还是必须使用硬件地址。
每一个主机都设有一个**ARP 高速缓存**(ARP cache)，里面有所在的局域网上的各主机和路由器的 IP 地址到硬件地址的映射表。
< IP address；MAC address；TTL >
TTL (Time To Live)：地址映射有效时间。
当主机 A 欲向本局域网上的某个主机 B 发送 IP 数据报时，就先在其 ARP 高速缓存中查看有无主机 B 的 IP 地址。
如有，就可查出其对应的硬件地址，再将此硬件地址写入 MAC 帧，然后通过局域网将该 MAC 帧发往此硬件地址。
如没有， ARP 进程在本局域网上广播发送一个 ARP 请求分组。收到 ARP 响应分组后，将得到的 IP 地址到硬件地址的映射写入 ARP 高速缓存。

**ARP请求分组**：包含发送方硬件地址 / 发送方 IP 地址 / 目标方硬件地址(未知时填 0) / 目标方 IP 地址。
**本地广播 ARP 请求**（路由器不转发ARP请求）。
**ARP 响应分组**：包含发送方硬件地址 / 发送方 IP地址 / 目标方硬件地址 / 目标方 IP 地址。
**ARP 分组封装在物理网络的帧中传输。**
![image-20200609190717815](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200609190717815.png)
ARP 高速缓存的**作用**
存放最近获得的 IP 地址到 MAC 地址的绑定，以减少 ARP 广播的数量。
为了减少网络上的通信量，主机 A 在发送其 ARP 请求分组时，就将自己的 IP 地址到硬件地址的映射写入 ARP 请求分组。
当主机 B 收到 A 的 ARP 请求分组时，就将主机 A 的这一地址映射写入主机 B 自己的 ARP 高速缓存中。这对主机 B 以后向 A 发送数据报时就更方便了。

ARP 是解决同一个局域网上的主机或路由器的 IP 地址和硬件地址的映射问题。
如果所要找的主机和源主机不在同一个局域网上，那么就要通过 ARP 找到一个位于本局域网上的某个路由器的硬件地址，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络。剩下的工作就由下一个网络来做。
从 IP 地址到硬件地址的解析是自动进行的，主机的用户对这种地址解析过程是不知道的。
只要主机或路由器要和本网络上的另一个已知 IP 地址的主机或路由器进行通信，ARP 协议就会自动地将该 IP 地址解析为链路层所需要的硬件地址

为什么不直接使用硬件地址进行通信？
由于全世界存在着各式各样的网络，它们使用不同的硬件地址。要使这些异构网络能够互相通信就必须进行非常复杂的硬件地址转换工作，因此几乎是不可能的事。
IP 编址把这个复杂问题解决了。连接到互联网的主机只需各自拥有一个唯一的 IP 地址，它们之间的通信就像连接在同一个网络上那样简单方便，因为上述的调用 ARP 的复杂过程都是由计算机软件自动进行的，对用户来说是看不见这种调用过程的。
因此，在虚拟的 IP 网络上用 IP 地址进行通信给广大的计算机用户带来了很大的方便。

**4.2.5  IP 数据报的格式**
一个 IP 数据报由**首部**和**数据**两部分组成。
首部的前一部分是固定长度，共20 字节，是所有 IP 数据报必须具有的。
在首部的固定部分的后面是一些可选字段，其长度是可变的。
![image-20200609214001565](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200609214001565.png)
首部的前一部分是固定长度，共20 字节，是所有 IP 数据报必须具有的。可选字段，其长度是可变的
 IP 数据报首部的固定部分中的各字段:
版本——占4 位，指 IP 协议的版本。目前的 IP 协议版本号为4 (即 IPv4)。
首部长度——占4 位，可表示的最大数值是15 个单位(一个单位为4 字节)，因此 IP 的首部长度的最大值是60 字节。
区分服务——占8 位，用来获得更好的服务。在一般的情况下都不使用这个字段
总长度——占16 位，指首部和数据之和的长度，单位为字节，因此数据报的最大长度为65535 字节。总长度必须不超过最大传送单元 MTU。
标识(identification)——占16 位，它是一个计数器，用来产生**IP 数据报的标识**。
标志(flag)——占3 位，目前只有前两位有意义。
标志字段的最低位是 MF (More Fragment)。MF=1 表示后面“还有分片”。MF=0 表示最后一个分片。
标志字段中间的一位是 DF (Don't Fragment)。只有当 DF=0 时才允许分片。
片偏移——占13 位，指出：较长的分组在分片后，某片在原分组中的相对位置。片偏移以8 个字节为偏移单位。
生存时间——占8 位，记为 TTL (Time To Live)，指示数据报在网络中可通过的路由器数的最大值。
协议——占8 位，指出此数据报携带的数据使用何种协议，以便目的主机的 IP 层将数据部分上交给那个处理过程
首部检验和——占16 位，**只检验**数据报的**首部**，不检验数据部分。这里不采用 CRC 检验码而采用简单的计算方法。
源地址和目的地址都各占4 字节

【例】IP 数据报分片
一数据报的总长度为3820 字节，其数据部分的长度为3800 字节（使用固定首部），需要分片为长度不超过1420 字节的数据报片。
因固定首部长度为20 字节，因此每个数据报片的数据部分长度不能超过1400 字节。
于是分为3 个数据报片，其数据部分的长度分别为1400、1400 和1000 字节。
原始数据报首部被复制为各数据报片的首部，但必须修改有关字段的值。
![image-20200609214911225](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200609214911225.png)
![image-20200609214920402](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200609214920402.png)

首部检验和
![image-20200609214952129](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200609214952129.png)

IP 数据报首部的可变部分
IP 首部的可变部分就是一个选项字段，用来支持排错、测量以及安全等措施，内容很丰富。
选项字段的长度可变，从1 个字节到40 个字节不等，取决于所选择的项目。
增加首部的可变部分是为了增加 IP 数据报的功能，但这同时也使得 IP 数据报的首部长度成为可变的。这就增加了每一个路由器处理数据报的开销。
实际上这些选项很少被使用。

**4.2.6  IP 层转发分组的流程**
假设：有四个 A 类网络通过三个路由器连接在一起。每一个网络上都可能有成千上万个主机。
可以想像，若按目的主机号来制作路由表，每一个路由表就有4 万个项目，即4 万行（每一行对应于一台主机），则所得出的路由表就会过于庞大。
但若按主机所在的网络地址来制作路由表，那么每一个路由器中的路由表就只包含4 个项目（每一行对应于一个网络），这样就可使路由表大大简化。

在路由表中，对每一条路由，最主要的是，目的网络地址，下一跳地址
![image-20200609215341605](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200609215341605.png)
**根据目的网络地址**就能确定下一跳路由器，这样做的结果是：
IP 数据报最终一定可以找到目的主机所在目的网络上的路由器（可能要通过多次的间接交付）。只有到达最后一个路由器时，才试图向目的主机进行直接交付。
虽然互联网所有的分组转发都是基于目的主机所在的网络，但在大多数情况下都允许有这样的特例，即为特定的目的主机指明一个路由。
采用特定主机路由可使网络管理人员能更方便地控制网络和测试网络，同时也可在需要考虑某种安全问题时采用这种特定主机路由。
路由器还可采用**默认路由**(default route)以减少路由表所占用的空间和搜索路由表所用的时间。
这种转发方式在一个网络只有很少的对外连接时是很有用的。
默认路由在主机发送 IP 数据报时往往更能显示出它的好处。
如果一个主机连接在一个小网络上，而这个网络只用一个路由器和互联网连接，那么在这种情况下使用默认路由是非常合适的。
![image-20200609215555145](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200609215555145.png)
IP 数据报的首部中**没有**地方可以用来指明“下一跳路由器的 IP 地址”。
当路由器收到待转发的数据报，不是将下一跳路由器的 IP 地址填入 IP 数据报，而是**送交**下层的网络接口软件。
网络接口软件**使用 ARP**负责将下一跳路由器的 IP 地址转换成硬件地址，并将此硬件地址放在链路层的 MAC 帧的首部，然后根据这个硬件地址找到下一跳路由器。

路由器分组转发算法
(1)从数据报的首部提取目的主机的 IP 地址 D,得出目的网络地址为 N。
(2)若网络 N 与此路由器直接相连，则把数据报直接交付目的主机 D；否则是间接交付，执行(3)。
(3)若路由表中有目的地址为 D 的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行(4)。
(4)若路由表中有到达网络 N 的路由，则把数据报传送给路由表指明的下一跳路由器；否则，执行(5)。
(5)若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行(6)。
(6)报告转发分组出错。

## 4.3 划分子网和构造超网

**4.3.1 划分子网**
1.从两级 IP 地址到三级 IP 地址
在 ARPANET 的早期，IP 地址的设计确实不够合理：
(1) IP 地址空间的利用率有时很低。
(2)给每一个物理网络分配一个网络号会使路由表变得太大因而使网络性能变坏。
(3)两级的 IP 地址不够灵活。
三级 IP 地址
从1985 年起在 IP 地址中又增加了一个“**子网号字段**”，使两级的 IP 地址变成为**三级的 IP 地址**。
这种做法叫做**划分子网**(subnetting)。划分子网已成为互联网的正式标准协议。

划分子网的基本思路
划分子网纯属一个单位内部的事情。单位对外仍然表现为没有划分子网的网络。
从主机号借用若干个位作为子网号 subnet-id，而主机号 host-id 也就相应减少了若干个位。
凡是从其他网络发送给本单位某个主机的 IP 数据报，仍然是根据 IP 数据报的目的网络号 net-id，先找到连接在本单位网络上的路由器。
然后此路由器在收到 IP 数据报后，再按目的网络号 net-id 和子网号 subnet-id 找到目的子网。
最后就将 IP 数据报直接交付目的主机。
![image-20200609215921622](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200609215921622.png)

![image-20200609220143665](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200609220143665.png)
当没有划分子网时，IP 地址是两级结构。
划分子网后 IP 地址就变成了三级结构。
划分子网只是把 IP 地址的主机号 host-id 这部分进行再划分，而不改变 IP 地址原来的网络号 net-id。
优点：减少了 IP 地址的浪费使网络的组织更加灵活更便于维护和管理。
划分子网纯属一个单位内部的事情，对外部网络透明，对外仍然表现为没有划分子网的一个网络。

**2.子网掩码**
从一个 IP 数据报的首部并无法判断源主机或目的主机所连接的网络是否进行了子网划分。
使用**子网掩码(subnet mask)**可以找出 IP 地址中的子网部分。
规则：
子网掩码长度＝32 位
某位＝1：IP地址中的对应位为网络号和子网号
某位＝0：IP地址中的对应位为主机号

(IP 地址) AND (子网掩码)=网络地址
![image-20200609221115213](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200609221115213.png)
![image-20200609221130615](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200609221130615.png)
**子网掩码是一个网络或一个子网的重要属性**。
路由器在和相邻路由器交换路由信息时，必须把自己所在网络（或子网）的子网掩码告诉相邻路由器。
路由器的路由表中的每一个项目，除了要给出目的网络地址外，还必须同时给出该网络的子网掩码。
若一个路由器连接在两个子网上就拥有两个网络地址和两个子网掩码。

子网划分方法
有**固定长度子网**和**变长子网**两种子网划分方法。
在采用固定长度子网时，所划分的所有子网的子网掩码都是**相同**的。
虽然根据已成为互联网标准协议的 RFC 950 文档，子网号不能为全1 或全0，但随着无分类域间路由选择 CIDR 的广泛使用，现在全1 和全0 的子网号也可以使用了，但一定要谨慎使用，确认你的路由器所用的路由选择软件是否支持全0 或全1 的子网号这种较新的用法。
划分子网增加了灵活性，但却减少了能够连接在网络上的主机总数。
![image-20200609222126763](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200609222126763.png)
![image-20200609222138969](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200609222138969.png)
![image-20200609222151416](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200609222151416.png)
以二进制看子网掩码，B类地址的子网划分，如果子网掩码为255.0=（11111111.00000000）8个1，那么有(2^8)-2个子网
如果有子网掩码为252.0=（11111100.00000000）6个1，那么有(2^6)-2个子网，有几个0就是每个子网的主机数(2^零数)-2

**4.3.2 使用子网时分组的转发**
在不划分子网的两级 IP 地址下，从 IP 地址得出网络地址是个很简单的事。
但在划分子网的情况下，从 IP 地址却不能唯一地得出网络地址来，这是因为网络地址取决于那个网络所采用的子网掩码，但**数据报的首部并没有提供子网掩码**的信息。
因此分组转发的算法也必须做相应的改动。

在划分子网情况下路由器转发分组的算法
(1)从收到的分组的首部提取目的 IP 地址 D。
(2)先用各网络的子网掩码和 D 逐位相“与”，看是否和相应的网络地址匹配。若匹配，则将分组直接交付。否则就是间接交付，执行(3)。
(3)若路由表中有目的地址为 D 的特定主机路由，则将分组传送给指明的下一跳路由器；否则，执行(4)。
(4)对路由表中的每一行，将子网掩码和 D 逐位相“与”。若结果与该行的目的网络地址匹配，则将分组传送给该行指明的下一跳路由器；否则，执行(5)。
(5)若路由表中有一个默认路由，则将分组传送给路由表中所指明的默认路由器；否则，执行(6)。
(6)报告转发分组出错。

【例4-4】已知互联网和路由器 R1 中的路由表。主机 H1 向 H2 发送分组。试讨论 R1 收到 H1 向 H2 发送的分组后查找路由表的过程。
要发送的分组的目的 IP 地址：128.30.33.138![image-20200609224640949](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200609224640949.png)
因此 H1 首先检查主机128.30.33.138 是否连接在本网络上如果是，则直接交付；否则，就送交路由器 R1，并逐项查找路由表。
![image-20200609224739304](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200609224739304.png)
因此 H1 必须把分组传送到路由器 R1然后逐项查找路由表
255.255.255.128 AND 128.30.33.138 = 128.30.33.128 匹配
这表明子网2 就是收到的分组所要寻找的目的网络。
符合目标网络地址128.30.33.128 子网掩码255.255.255.128，下一跳，接口1。

**4.3.3 无分类编址 CIDR（构造超网）**
1.网络前缀
划分子网在一定程度上缓解了互联网在发展中遇到的困难。然而在1992 年互联网仍然面临三个必须尽早解决的问题：
(1) B 类地址在1992 年已分配了近一半，眼看就要在1994 年3 月全部分配完毕！
(2)互联网主干网上的路由表中的项目数急剧增长（从几千个增长到几万个）。
(3)整个 IPv4 的地址空间最终将全部耗尽。
1987 年，RFC 1009 就指明了在一个划分子网的网络中可同时使用几个不同的子网掩码。
使用**变长子网掩码 VLSM**(Variable Length Subnet Mask)可进一步提高 IP 地址资源的利用率。
在 VLSM 的基础上又进一步研究出无分类编址方法，它的正式名字是**无分类域间路由选择 CIDR**(Classless Inter-Domain Routing)。
CIDR 消除了传统的 A 类、B 类和 C 类地址以及划分子网的概念，因而可以更加有效地分配 IPv4 的地址空间。
CIDR 最主要的特点：
CIDR使用各种长度的“**网络前缀**”(network-prefix)来代替分类地址中的网络号和子网号。
IP 地址从三级编址（使用子网掩码）又回到了两级编址。

无分类的两级编址的记法是：
![image-20200609225333951](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200609225333951.png)
CIDR 使用“**斜线记法**”(slash notation)，它又称为**CIDR 记法**，即在 IP 地址面加上一个斜线“/”，然后写上网络前缀所占的位数（这个数值对应于三级编址中**子网掩码中1 的个数**）。例如：220.78.168.0/24

CIDR 把网络前缀都相同的连续的 IP 地址组成“**CIDR 地址块**”。
128.14.32.0/20 表示的地址块**共有2^12 个地址**（因为斜线后面的20 是**网络前缀的位数**，所以这个地址的主机号是12 位）。
这个地址块的起始地址是128.14.32.0。
在不需要指出地址块的起始地址时，也可将这样的地址块简称为“/20 地址块”。
128.14.32.0/20 地址块的最小地址：128.14.32.0
128.14.32.0/20 地址块的最大地址：128.14.47.255
**全0 和全1 的主机号地址一般不使用。**

**路由聚合(**route aggregation)
一个 CIDR 地址块可以表示很多地址，这种地址的聚合常称为**路由聚合**，它使得路由表中的一个项目可以表示很多个（例如上千个）原来传统分类地址的路由。
路由聚合有利于减少路由器之间的路由选择信息的交换，从而提高了整个互联网的性能。
路由聚合也称为构成**超网(supernetting)**。
CIDR 虽然不使用子网了，但仍然使用“**掩码”**这一名词（但不叫子网掩码）。
对于/20 地址块，它的掩码是20 个连续的1。斜线记法中的数字就是掩码中1的个数。

CIDR 记法的其他形式
10.0.0.0/10 可简写为10/10，也就是把点分十进制中低位连续的0 省略。
10.0.0.0/10 隐含地指出 IP 地址10.0.0.0 的掩码是255.192.0.0。此掩码可表示为：11111111 11000000 00000000 00000000 有10个连续的1
网络前缀的后面加一个星号*的表示方法，如00001010 00*，在星号*之前是网络前缀，而星号*表示 IP 地址中的主机号，可以是任意值。
![image-20200609231034741](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200609231034741.png)
构成超网
前缀长度不超过23 位的 CIDR 地址块都包含了多个 C 类地址。
这些 C 类地址合起来就构成了超网。
CIDR 地址块中的地址数一定是2 的整数次幂。
网络前缀越短，其地址块所包含的地址数就越多。而在三级结构的IP地址中，划分子网是使网络前缀变长。
CIDR 的一个好处是：可以更加有效地分配 IPv4 的地址空间，可根据客户的需要分配适当大小的 CIDR 地址块。
![image-20200609232555060](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200609232555060.png)
这个 ISP 共有64 个 C 类网络。如果不采用 CIDR 技术，则在与该 ISP 的路由器交换路由信息的每一个路由器的路由表中，就需要有64 个项目。但采用地址聚合后，只需用路由聚合后的1 个项目206.0.64.0/18 就能找到该 ISP。

2.最长前缀匹配
使用 CIDR 时，路由表中的每个项目由“网络前缀”和“下一跳地址”组成。在查找路由表时可能会得到不止一个匹配结果。
应当从匹配结果中**选择具有最长网络前缀**的路由：**最长前缀匹配**(longest-prefix matching)。
网络前缀越长，其地址块就越小，因而路由就越具体(more specific)。
最长前缀匹配又称为**最长匹配或最佳匹配**。
【例】收到的分组的目的地址 D = 206.0.71.130
路由表中的项目：206.0.68.0/22  206.0.71.128/25
查找路由表中的第1 个项目：
第1 个项目206.0.68.0/22 的掩码 M 有22 个连续的1。
M =    11111111 11111111 11111111 10000000
D  = 206.			0.			   01000111 . 130
=  206.0.68.0/22
第2 个项目206.0.71.128/25 的掩码 M 有25 个连续的1。
M =    11111111 11111111 11111111 10000000
D  =  	206.   		0.				71.		    10000010
=206.0.71.128/25
选择两个匹配的地址中更具体的一个，即选择最长前缀的地址。选第二个

3.使用二叉线索查找路由表
当路由表的项目数很大时，怎样设法减小路由表的查找时间就成为一个非常重要的问题。
为了进行更加有效的查找，通常是将无分类编址的路由表存放在一种层次的数据结构中，然后自上而下地按层次进行查找。这里最常用的就是**二叉线索**(binary trie)。
IP 地址中从左到右的比特值决定了从根结点逐层向下层延伸的路径，而二叉线索中的各个路径就代表路由表中存放的各个地址。
为了提高二叉线索的查找速度，广泛使用了各种压缩技术。
![image-20200609233730698](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200609233730698.png)

## 4.4 网际控制报文协议 ICMP

为了更有效地转发 IP 数据报和提高交付成功的机会，在网际层使用了网际控制报文协议 ICMP (Internet Control Message Protocol)。
ICMP 是互联网的标准协议。
ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告。
但 ICMP 不是高层协议（看起来好像是高层协议，因为 ICMP 报文是装在 IP 数据报中，作为其中的数据部分），而是 IP 层的协议。
ICMP 报文的格式 
![image-20200610163932999](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200610163932999.png)
**4.4.1  ICMP 报文的种类**
ICMP 报文的种类有两种，即 ICMP **差错报告报文**和 ICMP **询问报文**。 
ICMP 报文的前 4 个字节是统一的格式，共有三个字段：即**类型**、**代码**和**检验和**。接着的 4 个字节的内容与 ICMP 的类型有关。 

ICMP 差错报告报文共有 4 种 ：终点不可达 、时间超过、参数问题 、改变路由（重定向）(Redirect) 
![image-20200610164213365](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200610164213365.png)
不应发送 ICMP 差错报告报文的几种情况 
对 ICMP 差错报告报文不再发送 ICMP 差错报告报文。
对第一个分片的数据报片的所有后续数据报片都不发送 ICMP 差错报告报文。
对具有多播地址的数据报都不发送 ICMP 差错报告报文。
对具有特殊地址（如127.0.0.0 或 0.0.0.0）的数据报不发送 ICMP 差错报告报文。

ICMP 询问报文有两种 ：回送请求和回答报文、时间戳请求和回答报文
几种 ICMP 报文不再使用：信息请求与回答报文、掩码地址请求和回答报文、路由器询问和通告报文 、源点抑制报文

**4.4.2  ICMP 的应用举例**
**PING (Packet InterNet Groper)** 
PING 用来测试两个主机之间的连通性。
PING 使用了 ICMP 回送请求与回送回答报文。
PING 是应用层直接使用网络层 ICMP 的例子，它没有通过运输层的 TCP 或UDP。 

**Traceroute 的应用举例**
在 Windows 操作系统中这个命令是 tracert。
用来跟踪一个分组从源点到终点的路径。
它利用 IP 数据报中的 TTL 字段和 ICMP 时间超过差错报告报文实现对从源点到终点的路径的跟踪。

## 4.5 互联网的路由选择协议

**4.5.1  有关路由选择协议的几个基本概念**

1.理想的路由算法：
算法必须是正确的和完整的。 算法在计算上应简单。 
算法应能适应通信量和网络拓扑的变化，这就是说，要有自适应性。 
算法应具有稳定性。 算法应是公平的。 算法应是最佳的。 

不存在一种绝对的最佳路由算法。
所谓“最佳”只能是相对于某一种特定要求下得出的较为合理的选择而已。
实际的路由选择算法，应尽可能接近于理想的算法。 
路由选择是个非常复杂的问题

**静态**路由选择策略——即非自适应路由选择，其特点是简单和开销较小，但不能及时适应网络状态的变化。 
**动态**路由选择策略——即自适应路由选择，其特点是能较好地适应网络状态的变化，但实现起来较为复杂，开销也比较大。  

2.分层次的路由选择协议
**互联网采用分层次的路由选择协议。**这是因为：
(1) 互联网的规模非常大。如果让所有的路由器知道所有的网络应怎样到达，则这种路由表将非常大，处理起来也太花时间。而所有这些路由器之间交换路由信息所需的带宽就会使互联网的通信链路饱和。
(2) 许多单位不愿意外界了解自己单位网络的布局细节和本部门所采用的路由选择协议（这属于本部门内部的事情），但同时还希望连接到互联网上。   

自治系统 AS(Autonomous System) 
自治系统 AS 的**定义**：在单一的技术管理下的一组路由器，而这些路由器使用一种 AS 内部的路由选择协议和共同的度量以确定分组在该 AS 内的路由，同时还使用一种 AS 之间的路由选择协议用以确定分组在 AS之间的路由。
现在对自治系统 AS 的定义是强调下面的事实：尽管一个 AS 使用了多种内部路由选择协议和度量，但**重要的是**一个 AS 对其他 AS 表现出的是一个单一的和一致的路由选择策略。

互联网有两大类路由选择协议 
**内部网关协议 IGP** (Interior Gateway Protocol) 
在一个自治系统**内部使用**的路由选择协议。
目前这类路由选择协议使用得最多，如 RIP 和 OSPF 协议。
**外部网关协议 EGP** (External Gateway Protocol) 
若源站和目的站处在不同的自治系统中，当数据报传到一个自治系统的边界时，就需要使用一种协议**将路由选择信息传递到另一个自治系统中**。这样的协议就是外部网关协议 EGP。
在外部网关协议中目前使用最多的是 BGP-4。  

自治系统之间的路由选择也叫做**域间路由选择 (interdomain routing)**，在自治系统内部的路由选择叫做**域内路由选择 (intradomain routing)** 。

**#4.5.2  内部网关协议 RIP**

1.工作原理:
**路由信息协议 RIP (Routing Information Protocol)** 是内部网关协议 IGP 中最先得到广泛使用的协议。
RIP 是一种分布式的、基于距离向量的路由选择协议。
RIP 协议要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的**距离**记录。 
RIP 协议中的“距离”也称为“跳数”(hop count)，因为每经过一个路由器，跳数就加 1。
这里的“距离”实际上指的是“最短距离”。 
RIP 允许一条路径最多只能包含 15 个路由器。
RIP 不能在两个网络之间同时使用多条路由。
RIP 选择一个具有最少路由器的路由（即最短路由），哪怕还存在另一条高速(低时延)但路由器较多的路由。

RIP 协议的三个**特点** :
(1) 仅和**相邻路由器**交换信息。 
(2) 交换的信息是当前本路由器所知道的**全部信息**，即自己的路由表。 
(3) 按固定的时间间隔交换路由信息，例如，每隔 30 秒。当网络拓扑发生变化时，路由器也及时向相邻路由器通告拓扑变化后的路由信息。

路由表的建立 
路由器在刚刚开始工作时，只知道到直接连接的网络的距离（此距离定义为 1）。它的路由表是空的。
以后，每一个路由器也只和数目非常有限的相邻路由器交换并更新路由信息。
经过若干次更新后，所有的路由器最终都会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器的地址。
RIP 协议的**收敛** (convergence) 过程较快。“收敛”就是在自治系统中所有的结点都得到正确的路由选择信息的过程。 

2.距离向量算法:路由器收到相邻路由器（其地址为 X）的一个 RIP 报文：
(1) 先修改此 RIP 报文中的所有项目：把“下一跳”字段中的地址都改为 X，并把所有的“距离”字段的值加1。
(2)对修改后的 RIP 报文中的每一个项目，重复以下步骤：
（先比对网络）
若项目中的目的网络不在路由表中，则把该项目加到路由表中。
否则（接着比对网下一跳地址）
若下一跳字段给出的路由器地址是同样的，则把收到的项目替换原路由表中的项目。
否则（再比对距离）
若收到项目中的距离小于路由表中的距离，则进行更新，
否则，什么也不做。
(3)若3 分钟还没有收到相邻路由器的更新路由表，则把此相邻路由器记为不可达路由器，即将距离置为16（表示不可达）。
(4)返回。
![image-20200610182152726](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200610182152726.png)
3 .RIP2 协议的报文格式 
![image-20200610182339973](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200610182339973.png)
RIP2 报文由首部和路由部分组成。
RIP2 报文中的路由部分由若干个路由信息组成。每个路由信息需要用 20 个字节。地址族标识符（又称为**地址类别**）字段用来标志所使用的地址协议。
路由标记填入自治系统的号码，这是考虑使 RIP 有可能收到本自治系统以外的路由选择信息。
再后面指出某个网络地址、该网络的子网掩码、下一跳路由器地址以及到此网络的距离。 
一个 RIP 报文最多可包括 25 个路由，因而 RIP 报文的最大长度是 4 + 20 x 25 = 504 字节。如超过，必须再用一个 RIP 报文来传送。
RIP2 具有简单的**鉴别**功能。
若使用鉴别功能，则将原来写入第一个路由信息（20 个字节）的位置用作鉴别。
在鉴别数据之后才写入路由信息，但这时最多只能再放入 24 个路由信息。
RIP 协议**特点**：好消息传播得快，坏消息传播得慢。
RIP 存在的一个**问题**：当网络出现故障时，要经过比较长的时间 (例如数分钟) 才能将此信息传送到所有的路由器。

**#4.5.3  内部网关协议 OSPF**
开放最短路径优先 OSPF (Open Shortest Path First)是为克服 RIP 的缺点在 1989 年开发出来的。
OSPF 的原理很简单，但实现起来却较复杂。
1**.OSPF 协议的基本特点**：
“**开放**”表明 OSPF 协议不是受某一家厂商控制，而是公开发表的。
“**最短路径优先**”是因为使用了 Dijkstra 提出的最短路径算法 SPF
采用**分布式的链路状态协议 (link state protocol)**。 
注意：OSPF 只是一个协议的名字，它并不表示其他的路由选择协议不是“最短路径优先”。
向本自治系统中所有路由器发送信息，这里使用的方法是**洪泛法**。
发送的信息就是与本路由器**相邻**的所有路由器的链路状态，但这只是路由器所知道的部分信息。
*“链路状态”就是说明本路由器都和哪些路由器相邻，以及该链路的“**度量**”(metric)。* 
只有当链路状态发生变化时，路由器才用洪泛法向所有路由器发送此信息。  

由于各路由器之间频繁地交换链路状态信息，因此所有的路由器最终都能建立一个**链路状态数据库(link-state database)** 。
这个数据库实际上就是**全网的拓扑结构图**，它在全网范围内是一致的（这称为链路状态数据库的同步）。
OSPF 的链路状态数据库能较快地进行更新，使各个路由器能及时更新其路由表。
OSPF 的更新过程收敛得快是其重要优点。

为了使 OSPF 能够用于规模很大的网络，OSPF 将一个自治系统再划分为若干个更小的范围，叫做**区域**(area) 。
每一个区域都有一个 32 位的区域标识符（用点分十进制表示）。
区域也不能太大，在一个区域内的路由器最好不超过 200 个。
OSPF 划分为两种不同的区域 
![image-20200610184613304](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200610184613304.png)
划分区域的好处就是将利用洪泛法交换链路状态信息的范围局限于每一个区域而不是整个的自治系统，这就减少了整个网络上的通信量。
在一个区域内部的路由器只知道本区域的完整网络拓扑，而不知道其他区域的网络拓扑的情况。
OSPF **使用层次结构的区域划分**。在上层的区域叫做**主干区域** (backbone area)。
主干区域的标识符规定为0.0.0.0。主干区域的作用是用来连通其他在下层的区域。  

OSPF 不用 UDP 而是**直接用** IP 数据报传送。
OSPF 构成的数据报很短。这样做可减少路由信息的通信量。
数据报很短的另一好处是可以不必将长的数据报分片传送。
但分片传送的数据报只要丢失一个，就无法组装成原来的数据报，而整个数据报就必须重传。 

OSPF 的其他特点 
OSPF 对不同的链路可根据 IP 分组的不同服务类型 TOS 而设置成不同的代价。因此，**OSPF 对于不同类型的业务可计算出不同的路由**。
如果到同一个目的网络有多条相同代价的路径，那么可以将通信量分配给这几条路径。这叫做**多路径间的负载平衡**。
所有在 OSPF 路由器之间交换的分组都具有**鉴别**的功能。
**支持**可变长度的子网划分和无分类编址 CIDR。
每一个链路状态都带上一个 32 位的序号，序号越大状态就越新。
![image-20200610190203358](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200610190203358.png)

2.OSPF 的五种分组类型 
类型1，问候 (Hello) 分组。
类型2，数据库描述 (Database Description) 分组。
类型3，链路状态请求 (Link State Request) 分组。
类型4，链路状态更新 (Link State Update) 分组，用**洪泛法**对全网更新链路状态。
类型5，链路状态确认 (Link State Acknowledgment)分组。 
![image-20200610190322547](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200610190322547.png)
![image-20200610190339804](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200610190339804.png)
OSPF 还规定每隔一段时间，如 30 分钟，要刷新一次数据库中的链路状态。 
由于一个路由器的链路状态只涉及到与相邻路由器的连通状态，因而与整个互联网的规模并无直接关系。因此**当**互联网规模很大**时**，OSPF  协议要比距离向量协议 RIP 好得多。 
OSPF 没有“坏消息传播得慢”的问题，据统计，其响应网络变化的时间小于 100 ms。 

多点接入的局域网采用了**指定的路由器** (designated router) 的方法，使广播的信息量大大减少。
指定的路由器**代表**该局域网上所有的链路向连接到该网络上的各路由器发送状态信息。 

**4.5.4  外部网关协议 BGP**
BGP 是**不同自治系统的路由器之间**交换路由信息的协议。 
BGP 较新版本是 2006 年 1 月发表的 BGP-4（BGP 第 4 个版本），即 RFC 4271 ~ 4278。 
可以将 BGP-4 简写为 BGP。 

互联网的规模太大，使得自治系统之间路由选择非常困难。对于自治系统之间的路由选择，要寻找最佳路由是很不现实的。
当一条路径通过几个不同 AS 时，要想对这样的路径计算出有意义的代价是不太可能的。
比较合理的做法是在 AS 之间交换“可达性”信息。
自治系统之间的路由选择必须考虑有关策略。
因此，边界网关协议 BGP 只能是力求寻找一条能够到达目的网络且**比较好**的路由（不能兜圈子），而并**非要**寻找一条最佳路由。  

每一个自治系统的管理员要选择至少一个路由器作为该自治系统的“ **BGP 发言人**” (BGP speaker) 。
一般说来，两个 BGP 发言人都是通过一个共享网络连接在一起的，而 BGP 发言人往往就是 BGP 边界路由器，但也可以不是 BGP 边界路由器。 
一个 BGP 发言人与其他自治系统中的 BGP 发言人要交换路由信息，就要先建立 **TCP 连接**，然后在此连接上交换 BGP 报文以建立 BGP 会话(session)，利用 BGP **会话**交换路由信息。
使用 TCP 连接能提供可靠的服务，也简化了路由选择协议。
使用 TCP 连接交换路由信息的两个 BGP 发言人，彼此成为对方的**邻站**(neighbor)或**对等站**(peer) 。

BGP 所交换的网络可达性的信息就是要到达某个网络所要经过的一系列 AS。
当 BGP 发言人互相交换了网络可达性的信息后，各 BGP 发言人就根据所采用的策略从收到的路由信息中找出到达各 AS 的较好路由。 

BGP 协议的**特点**：
BGP 协议交换路由信息的结点数量级是自治系统数的量级，这要比这些自治系统中的网络数少很多。
每一个自治系统中 BGP 发言人（或边界路由器）的数目是很少的。这样就使得自治系统之间的路由选择不致过分复杂。  
BGP-4 共使用四种报文 ：
(1) **打开** (OPEN) 报文，用来与相邻的另一个BGP发言人建立关系。
(2) **更新** (UPDATE) 报文，用来发送某一路由的信息，以及列出要撤消的多条路由。
(3) **保活** (KEEPALIVE) 报文，用来确认打开报文和周期性地证实邻站关系。
(4) **通知** (NOTIFICATION) 报文，用来发送检测到的差错。
![image-20200610201742842](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200610201742842.png)

**4.5.5  路由器的构成**
路由器是一种典型的网络层设备。
路由器是互联网中的关键设备。
路由器的主要作用是：连通不同的网络。选择信息传送的线路。选择通畅快捷的近路，能大大提高通信速度，减轻网络系统通信负荷，节约网络系统资源，提高网络系统畅通率，从而让网络系统发挥出更大的效益来。

1.路由器的**结构**
路由器是一种具有多个输入端口和多个输出端口的专用计算机，其任务是转发分组。也就是说，将路由器某个输入端口收到的分组，按照分组要去的目的地（即目的网络），把该分组从路由器的某个合适的输出端口转发给下一跳路由器。
下一跳路由器也按照这种方法处理分组，直到该分组到达终点为止。 
路由器的**转发分组**正是网络层的主要工作。
![image-20200610201909551](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200610201909551.png)
整个的路由器结构可划分为两大部分：路由选择部分、分组转发部分。
**路由选择部分**：
也叫做控制部分，其核心构件是路由选择处理机。
路由选择处理机的任务是根据所选定的路由选择协议构造出路由表，同时经常或定期地和相邻路由器交换路由信息而不断地更新和维护路由表。
**分组转发部分**由三部分组成：
**交换结构** (switching fabric)：又称为交换组织，其作用是根据**转发表** (forwarding table) 对分组进行处理。
一组输入端口
一组输出端口
（请注意：这里的端口就是硬件接口）

“转发”和“路由选择”的区别 
“**转发**”(forwarding) 就是路由器根据转发表将用户的 IP 数据报从合适的端口转发出去。
“**路由选择**”(routing) 则是按照分布式算法，根据从各相邻路由器得到的关于网络拓扑的变化情况，动态地改变所选择的路由。
路由表是根据路由选择算法得出的。而转发表是从路由表得出的。
在讨论路由选择的原理时，往往不去区分转发表和路由表的区别。

输入端口中的查找和转发功能在路由器的交换功能中是最重要的。
![image-20200610202215505](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200610202215505.png)
![image-20200610202222726](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200610202222726.png)
分组丢弃 
若路由器处理分组的速率赶不上分组进入队列的速率，则队列的存储空间最终必定减少到零，这就使后面再进入队列的分组由于没有存储空间而只能被丢弃。
路由器中的输入或输出队列产生溢出是造成分组丢失的重要原因。

2.**交换结构**
交换结构是路由器的关键构件。
正是这个交换结构把分组从一个输入端口转移到某个合适的输出端口。
实现交换有多种方法。常用交换方法有三种：通过存储器、通过总线、通过纵横交换结构

**通过存储器**
当路由器的某个输入端口收到一个分组时，就用中断方式通知路由选择处理机。然后分组就从输入端口复制到存储器中。
路由器处理机从分组首部提取目的地址，查找路由表，再将分组复制到合适的输出端口的缓存中。
若存储器的带宽（读或写）为每秒 M 个分组，那么路由器的交换速率（即分组从输入端口传送到输出端口的速率）一定小于 M/2。
**通过总线**
数据报从输入端口通过共享的总线直接传送到合适的输出端口，而不需要路由选择处理机的干预。
因为每一个要转发的分组都要通过这一条总线，因此路由器的转发带宽就受总线速率的限制。
现代的技术已经可以将总线的带宽提高到每秒吉比特的速率，因此许多的路由器产品都采用这种通过总线的交换方式。
**通过纵横交换结构** (crossbar switch fabric)
这种交换结构常称为互连网络 (interconnection network)。
它有 2N 条总线，可以使 N 个输入端口和 N 个输出端口相连接。
当输入端口收到一个分组时，就将它发送到与该输入端口相连的水平总线上。
若通向所要转发的输出端口的垂直总线是空闲的，则在这个结点将垂直总线与水平总线接通，然后将该分组转发到这个输出端口。
但若该垂直总线已被占用（有另一个分组正在转发到同一个输出端口），则后到达的分组就被阻塞，必须在输入端口排队。
![image-20200610202514920](https://twelveeee-note.oss-cn-beijing.aliyuncs.com/Image/image-20200610202514920.png)

## 4.6  IPv6

IP 是互联网的核心协议。
互联网经过几十年的飞速发展，到 2011 年 2 月，IPv4 的 32 位地址已经耗尽。
ISP 已经不能再申请到新的 IP 地址块了。
我国在 2014 – 2015 年也逐步停止了向新用户和应用分配 IPv4 地址。
解决 IP 地址耗尽的根本措施就是采用具有更大地址空间的新版本的 IP，即 IPv6。

**4.6.1  IPv6 的基本首部**
IPv6 仍支持无连接的传送，但将协议数据单元 PDU 称为分组。为方便起见，本书仍采用数据报这一名词。
所引进的主要变化如下：
更大的地址空间。IPv6 将地址从 IPv4 的 32 位 增大到了 128 位。 
扩展的地址层次结构。 
灵活的首部格式。 IPv6 定义了许多可选的扩展首部。
改进的选项。 IPv6 允许数据报包含有选项的控制信息，其选项放在有效载荷中。

所引进的主要变化如下（续）：
允许协议继续扩充。 
支持即插即用（即自动配置）。因此 IPv6 不需要使用 DHCP。
支持资源的预分配。  IPv6 支持实时视像等要求，保证一定的带宽和时延的应用。
IPv6 首部改为 8 字节对齐。首部长度必须是 8 字节的整数倍。原来的 IPv4 首部是 4 字节对齐。

**4.6.2  IPv6 的地址**
**4.6.3  从 IPv4 向 IPv6 过渡**
**4.6.4  ICMPv6**



4.7  IP 多播



4.8 虚拟专用网 VPN 和网络地址转换 NAT

## 4.9 多协议标记交换 MPLS

