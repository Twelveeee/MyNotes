# 消息队列

## 简介

MQ(Message Queue)

消息队列可以简单理解为：把要传输的数据放在队列中。
把数据放到消息队列叫做生产者
从消息队列里边取数据叫做消费者

## 作用

**解藕**
解除模块和模块之间的耦合性，比如A模块要给BCD模块提供数据，BCD在调用A模块的数据的时候都需要重新运行A模块的方法，如果A模块的接口发生改变，BCD模块就GG了。但是如果A模块把数据输出到消息队列中，BCD模块直接去消息队列取数据，即便A模块的结构发生改变，BCD模块也不需要改动，这就降低了模块和模块之间的耦合性。

**异步**
A模块要给BCD模块提供数据，BCD在调用A模块的数据的时候都需要重新运行A模块的方法，一共要运行三次，那么如果A模块把数据存到消息队列中，BCD只要异步调用队列中的东西就行了。

**限流/削峰**
如果大促，每秒有3000个请求，但是两台服务器分别只能处理1000条数据。剩下的请求就无效了。
但是如果把请求直接放到消息队列中，让服务器去消息队列中取数据，就不会存在请求被丢弃的情况。

## 问题

**高可用**
如果是单机的消息队列，消息队列炸了，那么剩下的服务器全都获取不到数据，整个服务就炸了。

**数据丢失**
如果将数据写在消息队列上，服务器还没读取消息队列的数据，消息队列就挂了，数据就丢失了。

**重复消费**
消费者A读了数据，就挂掉了，消费者B去消费A的partition，结果不久消费者A重启了，又消费了一遍这一条数据（或者消费者超时）
如果不允许重复消费的问题，最好从消费者端做业务上的校验，如果已经消费过了就不消费了。

## **应用场景**

可以使用mq的场景有很多，最常用的几种，是做业务解耦/最终一致性/广播/错峰流控等。反之，如果需要强一致性，关注业务逻辑的处理结果，则RPC显得更为合适。

# Kafka

官网：https://kafka.apache.org/intro

**简介**
Kafka 是一种分布式的，基于发布 / 订阅的消息系统。

## 基础概念

kafka是一个消息队列，把消息放到队列里面的是生产者(**Producer**)，从队列里面拿数据的是消费者(**Consumer**)。
**Consumer Group （CG）**:消费者组。
**Broker**:一台kafka服务器。
**Topic**:可以理解为一个队列。
**Partition**:一个非常大的topic可以拆分为多个Partition，分布到多个Broker里面。每个partition都是一个有序的队列，里面的每条信息都会被分配一个有序的ID ( **offset** )。kafka只保证按一个partition的顺序将消息发送给consumer，不保证一个topic整体(多个partition)的顺序。
**Offset**：每一个消费者对一个topic都有一个offset ，用于标记当前消费者读到哪里。

生产者往topic生产数据，实际上这些数据会分不到不同的partition，存在不同的broker上。
消费者可以有多个，多个消费者组成一个消费者组，每个消费者去消费一个partition，提高吞吐量。如果消费者组里面的某个消费者挂掉了，那么其中的某个消费者就需要消费两个partition。如果消费者多于partition，那么就会有消费者空闲，不同的消费者组之间消费的topic是不同的。

消息队列模式：点对点模式，发布订阅模式：
点对点，一个生产者负责一个消息队列，一个消息队列被一个消费者消费。
发布-订阅模式：多个生产者生产的能被多个消费者消费。

**高可用：**
生产者生产的数据是存到不同的partition上的，每个partition都会在别的broker上有备份分区，以防这个broker挂了数据丢失。生产者和消费者都不对备份分区进行操作，只于主分区操作。备份分区只用于备份，不做读写。
如果某个broker挂了，就会选出其他broker的partition备份来作为主分区。原本的主分区变为备份分区。

**持久化：**
kafka将partition的数据写在磁盘上，不过kafka只允许追加写入，顺序访问，避免缓慢的io操作。
Kafka也不是partition一有数据就立马将数据写到磁盘上，它会先缓存一部分，等到足够多数据量或等待一定的时间再批量写入(flush)。

**特性**

**高吞吐、低延迟**：kakfa 最大的特点就是收发消息非常快，kafka 每秒可以处理几十万条消息，它的最低延迟只有几毫秒。
**高可用性**： 每个主题(topic) 包含多个分区(partition)，主题中的分区可以分布在不同的主机(broker)中。
**持久性、可靠性**： Kafka 能够允许数据的持久化存储，消息被持久化到磁盘，并支持数据备份防止数据丢失，Kafka 底层的数据存储是基于 Zookeeper 存储的，Zookeeper 我们知道它的数据能够持久存储。
**容错性**： 允许集群中的节点失败，某个节点宕机，Kafka 集群能够正常工作
**高并发**： 支持数千个客户端同时读写



## 应用场景

- 活动跟踪：Kafka 可以用来跟踪用户行为，比如我们经常回去淘宝购物，你打开淘宝的那一刻，你的登陆信息，登陆次数都会作为消息传输到 Kafka ，当你浏览购物的时候，你的浏览信息，你的搜索指数，你的购物爱好都会作为一个个消息传递给 Kafka ，这样就可以生成报告，可以做智能推荐，购买喜好等。
- 传递消息：Kafka 另外一个基本用途是传递消息，应用程序向用户发送通知就是通过传递消息来实现的，这些应用组件可以生成消息，而不需要关心消息的格式，也不需要关心消息是如何发送的。
- 度量指标：Kafka也经常用来记录运营监控数据。包括收集各种分布式应用的数据，生产各种操作的集中反馈，比如报警和报告。
- 日志记录：Kafka 的基本概念来源于提交日志，比如我们可以把数据库的更新发送到 Kafka 上，用来记录数据库的更新时间，通过kafka以统一接口服务的方式开放给各种consumer，例如hadoop、Hbase、Solr等。
- 流式处理：流式处理是有一个能够提供多种应用程序的领域。
- 限流削峰：Kafka 多用于互联网领域某一时刻请求特别多的情况下，可以把请求写入Kafka 中，避免直接请求后端程序导致服务崩溃。

## 问题

